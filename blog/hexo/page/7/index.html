<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/7/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-3bb34d2fe4a64ca8b93520c8498b812a" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/3bb34d2fe4a64ca8b93520c8498b812a/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/3bb34d2fe4a64ca8b93520c8498b812a/">MySQL 使用 IF 判断是否执行 SQL</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>语法<br><code>if(condition, value_if_true, value_if_false)</code></p>
<p>上面的三个参数的意思是，如果 <code>condition</code>（表达式）为 <code>true</code>，则执行表达式 <code>value_if_true</code>，否则执行表达式 <code>value_if_false</code>。</p>
<p>例如有下面这个 <code>User</code> 用户表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">User</span> (</span><br><span class="line">  name <span class="type">VARCHAR</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">  COMMENT <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  age  <span class="type">INT</span>         <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">  COMMENT <span class="string">&#x27;年龄&#x27;</span>,</span><br><span class="line">  sex  <span class="type">BOOLEAN</span>     <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">  COMMENT <span class="string">&#x27;性别&#x27;</span></span><br><span class="line">)</span><br><span class="line">  COMMENT <span class="string">&#x27;用户表&#x27;</span></span><br></pre></td></tr></table></figure>
<p>一个简单的根据属性查询列表的 SQL 语句大致如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">User</span></span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">  name <span class="operator">=</span> ?</span><br><span class="line">  <span class="keyword">AND</span> age <span class="operator">=</span> ?</span><br><span class="line">  <span class="keyword">AND</span> sex <span class="operator">=</span> ?;</span><br></pre></td></tr></table></figure>
<p>那么，现在问题来了。我们有一个需求就是如果性别为空，就查询全部的性别，否则就根据性别进行查询。这时就可以使用 if 来进行判断了（吾辈的某位同事就是碰到了这个坑。。。），如果 <code>condition</code>(<code>sex = null</code>) 为 <code>true</code>，就直接执行表达式 <code>value_if_true</code>(<code>true</code>)，否则执行 <code>value_if_false</code>(<code>sex = ?</code>)。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">FROM</span> <span class="keyword">User</span></span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">  name <span class="operator">=</span> ?</span><br><span class="line">  <span class="keyword">AND</span> age <span class="operator">=</span> ?</span><br><span class="line">  <span class="keyword">AND</span> if(sex <span class="operator">=</span> <span class="keyword">NULL</span>, <span class="literal">TRUE</span>, sex <span class="operator">=</span> ?);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：这里不要使用 <code>1 = 1</code> 而直接使用 <code>true</code> 就好了。<br>PS：这难道就是所谓的习惯成自然么。。。<br>附：诚然，在使用了 ORM 框架(例如 Mybatis 后)，基本上都可以对传入的参数进行判空处理，然而有时候会出现一种情况：<br>某个属性经由其他属性统合计算而得到，并非是实体（或是其他的什么）传入进来的参数，那便是只能使用 SQL 的原生语法了呢</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/3bb34d2fe4a64ca8b93520c8498b812a/" data-id="ckmcqox3100300kuv7r7ie5qt" data-title="MySQL 使用 IF 判断是否执行 SQL" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/" rel="tag">sql</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-3c16942a2e994263847a2ae35f2473aa" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/3c16942a2e994263847a2ae35f2473aa/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/3c16942a2e994263847a2ae35f2473aa/">Java 使用 FTP/SFTP</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>项目中需要使用 FTP，所以做了简单的 <code>FTP/SFTP</code> 封装，此处仅做一下记录。</p>
<blockquote>
<p>注：这里并未实现连接池管理，生产环境强烈建议手动实现连接池以提高性能！</p>
</blockquote>
<h2 id="UML-图像说明"><a href="#UML-图像说明" class="headerlink" title="UML 图像说明"></a>UML 图像说明</h2><h3 id="形状"><a href="#形状" class="headerlink" title="形状"></a>形状</h3><blockquote>
<p>注：此处参考自 IDEA UML 图中的颜色</p>
</blockquote>
<ul>
<li>蓝色：类/步骤</li>
<li>黄色：字段</li>
<li>红色：函数</li>
<li>紫色：配置</li>
</ul>
<h3 id="图形"><a href="#图形" class="headerlink" title="图形"></a>图形</h3><ul>
<li>长方形：类/配置文件/依赖项</li>
<li>圆角长方形：字段/函数/对象/变量</li>
<li>箭头：拥有/向下依赖的意思</li>
</ul>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>封装简单的通用操作</p>
<ul>
<li>上传单个文件</li>
<li>上传使用 <code>InputStream</code>(内存操作)</li>
<li>下载单个文件</li>
<li>下载得到 <code>InputStream</code>(内存操作)</li>
<li>创建目录</li>
<li>递归创建目录</li>
<li>删除单个文件/空目录</li>
<li>获取指定目录下的文件信息列表</li>
<li>获取文件/目录信息</li>
<li>递归获取文件/目录信息</li>
<li>递归删除目录</li>
<li>监听目录变化（内部使用）</li>
<li>异步上传后等待结果</li>
</ul>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol>
<li> 定义顶层接口 <code>FtpOperator</code>，具体实现由子类（<code>BasicFtpOperatorImpl</code>, <code>SftpOperatorImpl</code>）完成</li>
<li> 定义顶层配置文件基类 <code>FtpClientConfig</code>，包含着 ftp 连接必须的一些东西，具体细节在子类配置中 <code>BasicFtpClientConfig</code>, <code>SftpClientConfig</code></li>
<li> 添加工厂类 <code>FtpOperatorFactory</code>，根据不同子类的配置对象创建不同的 ftp 操作对象，并且一经创建就可以永久性使用</li>
<li> 添加 <code>FtpWatchConfig</code>, <code>FtpWatch</code>, <code>FtpWatchFactory</code> FTP 监听器</li>
<li> 添加集成 SpringBoot 中，读取 <code>application.yml</code> 中的配置，并创建不同的 <code>FtpOperator</code> 暴露给外部使用，动态初始化 FTP 监视器</li>
</ol>
<blockquote>
<p>注：这里使用 FTP 监视器的原因是为了避免每次上传数据后都要单独监听 FTP 目录的变化，造成 FTP 多线程连接数量过多<br>注：这里的并未实现 FTPClient 及 Jsch 的对象池管理，所以仅可参考实现，生产环境中仍需进行修改！</p>
</blockquote>
<p>图解如下</p>
<p><img src="https://img.rxliuli.com/20190226221826.png" alt="图解"></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>具体的代码吾辈就不贴到这里了，全部的代码已经放到 <a target="_blank" rel="noopener" href="https://github.com/rxliuli/java-ftp-example">GitHub 的公共仓库</a> 上了。</p>
<h2 id="FTP-使用"><a href="#FTP-使用" class="headerlink" title="FTP 使用"></a>FTP 使用</h2><p>FtpOperator API 图解<br><img src="https://img.rxliuli.com/20190302115433.png" alt="FtpOperator API 图解"></p>
<p>上传部分流程图解<br><img src="https://img.rxliuli.com/20190302120512.png" alt="上传部分流程图解"></p>
<h3 id="使用-FtpOperator-进行基本操作"><a href="#使用-FtpOperator-进行基本操作" class="headerlink" title="使用 FtpOperator 进行基本操作"></a>使用 FtpOperator 进行基本操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FtpSpringConfigTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FtpOperator ftp;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">()</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>&#123;</span><br><span class="line">        <span class="comment">// 上传数据</span></span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream is = <span class="keyword">new</span> ByteArrayInputStream(<span class="string">&quot;测试数据&quot;</span>.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> result = ftp.put(is, <span class="string">&quot;/test.txt&quot;</span>);</span><br><span class="line">        assertThat(result)</span><br><span class="line">                .isTrue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断数据是否存在于 ftp 服务器</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> exist = ftp.exist(<span class="string">&quot;/test.txt&quot;</span>);</span><br><span class="line">        assertThat(exist)</span><br><span class="line">                .isTrue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 从 ftp 服务器上下载数据</span></span><br><span class="line">        ftp.get(<span class="string">&quot;/test.txt&quot;</span>, is -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> List&lt;String&gt; list = IOUtils.readLines(is);</span><br><span class="line">                log.info(<span class="string">&quot;list: &#123;&#125;&quot;</span>, list);</span><br><span class="line">                assertThat(list)</span><br><span class="line">                        .isNotEmpty();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mkdir</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建文件夹</span></span><br><span class="line">        assertThat(ftp.mkdir(<span class="string">&quot;/test&quot;</span>))</span><br><span class="line">                .isTrue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">mkdirR</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 递归创建文件夹</span></span><br><span class="line">        assertThat(ftp.mkdirR(<span class="string">&quot;/test/test2/test3&quot;</span>))</span><br><span class="line">                .isTrue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ls</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取目录下的文件信息列表</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;Stat&gt; list = ftp.ls(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;list: &#123;&#125;&quot;</span>, list.stream()</span><br><span class="line">                .map(Stat::getPath)</span><br><span class="line">                .collect(Collectors.joining(<span class="string">&quot;\n&quot;</span>)));</span><br><span class="line">        assertThat(list)</span><br><span class="line">                .isNotEmpty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lsr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取目录下的文件信息列表</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;Stat&gt; list = ftp.lsR(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;list: &#123;&#125;&quot;</span>, list.stream()</span><br><span class="line">                .map(Stat::getPath)</span><br><span class="line">                .collect(Collectors.joining(<span class="string">&quot;\n&quot;</span>)));</span><br><span class="line">        assertThat(list)</span><br><span class="line">                .isNotEmpty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 删除单个文件</span></span><br><span class="line">        assertThat(ftp.rm(<span class="string">&quot;/test.txt&quot;</span>))</span><br><span class="line">                .isTrue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rmdir</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 删除指定空目录</span></span><br><span class="line">        assertThat(ftp.rmdir(<span class="string">&quot;/test/test2/test3&quot;</span>))</span><br><span class="line">                .isTrue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rmdirR</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 递归删除指定目录</span></span><br><span class="line">        assertThat(ftp.rmdirR(<span class="string">&quot;/test&quot;</span>))</span><br><span class="line">                .isTrue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用-FtpOperator-上传文件并监听结果"><a href="#使用-FtpOperator-上传文件并监听结果" class="headerlink" title="使用 FtpOperator 上传文件并监听结果"></a>使用 FtpOperator 上传文件并监听结果</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FtpSpringConfigTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FtpOperator ftp;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">watch</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, UnsupportedEncodingException </span>&#123;</span><br><span class="line">        <span class="comment">// 监听新文件 /test.md 的出现</span></span><br><span class="line">        <span class="keyword">final</span> String path = <span class="string">&quot;/test.md&quot;</span>;</span><br><span class="line">        ftp.watch((Predicate&lt;String&gt;) str -&gt; str.equals(path))</span><br><span class="line">                .thenAcceptAsync(stat -&gt; &#123;</span><br><span class="line">                    log.warn(<span class="string">&quot;stat: &#123;&#125;&quot;</span>, stat);</span><br><span class="line">                    assertThat(ftp.exist(stat.getPath()))</span><br><span class="line">                            .isNotNull();</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// 创建测试文件</span></span><br><span class="line">        <span class="keyword">final</span> ByteArrayInputStream is = <span class="keyword">new</span> ByteArrayInputStream(<span class="string">&quot;测试数据&quot;</span>.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">        log.warn(<span class="string">&quot;test file upload completed!&quot;</span>);</span><br><span class="line">        assertThat(ftp.put(is, path))</span><br><span class="line">                .isTrue();</span><br><span class="line">        <span class="comment">// 注意，这里有一个问题就是如果程序结束的太快，那么更新将变得不可能的！</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        <span class="comment">// 删除测试文件</span></span><br><span class="line">        ftp.rm(path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>那么，关于 Java 中使用 <code>FTP/SFTP</code> 便到此为止啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/3c16942a2e994263847a2ae35f2473aa/" data-id="ckmcqox3100320kuvgvp34m9u" data-title="Java 使用 FTP/SFTP" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-40a3c0c38dec4c618bc034441425e810" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/40a3c0c38dec4c618bc034441425e810/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/40a3c0c38dec4c618bc034441425e810/">配置文件 yml</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文主要引用自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/itdragon/p/8686554.html">Spring Boot 配置文件详解</a>，这里主要是为了进行记录以便吾辈进行查找。</p>
</blockquote>
<p>yml 是 YAML（YAML Ain’t Markup Language）语言的文件，以数据为中心，比 json、xml 等更适合做配置文件。</p>
<blockquote>
<p>对比：<br>yml 和 xml 相比，少了一些结构化的代码，使数据更直接，一目了然。<br>yml 和 json 呢？没有谁好谁坏，合适才是最好的。yml 的语法比 json 优雅，注释更标准，适合做配置文件。json 作为一种机器交换格式比 yml 强，更适合做 api 调用的数据交换。</p>
</blockquote>
<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><ul>
<li>以空格的缩进程度来控制层级关系。空格的个数并不重要，只要左边空格对齐则视为同一个层级。注意不能用 <code>tab</code> 代替 <code>空格</code>。且大小写敏感。支持字面值，对象，数组三种数据结构，也支持复合结构。</li>
<li>字面值：字符串，布尔类型，数值，日期。字符串默认不加引号，单引号会转义特殊字符。日期格式支持 <code>yyyy/MM/dd HH:mm:ss</code></li>
<li>对象：由键值对组成，形如 key:(空格)value 的数据组成。冒号后面的空格是必须要有的，每组键值对占用一行，且缩进的程度要一致，也可以使用行内写法：{k1: v1, ….kn: vn}</li>
<li>数组：由形如 -(空格)value 的数据组成。短横线后面的空格是必须要有的，每组数据占用一行，且缩进的程度要一致，也可以使用行内写法： [1,2,…n]</li>
<li>复合结构：上面三种数据结构任意组合</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>创建一个 Spring Boot 的全局配置文件 application.yml，配置属性参数。主要有字符串，带特殊字符的字符串，布尔类型，数值，集合，行内集合，行内对象，集合对象这几种常用的数据格式。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">yaml:</span></span><br><span class="line">  <span class="attr">str:</span> <span class="string">字符串可以不加引号</span></span><br><span class="line">  <span class="attr">specialStr:</span> <span class="string">&quot;双引号直接输出\n特殊字符&quot;</span></span><br><span class="line">  <span class="attr">specialStr2:</span> <span class="string">&#x27;单引号可以转义\n特殊字符&#x27;</span></span><br><span class="line">  <span class="attr">flag:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">num:</span> <span class="number">666</span></span><br><span class="line">  <span class="attr">Dnum:</span> <span class="number">88.88</span></span><br><span class="line">  <span class="attr">list:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">one</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">two</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">two</span></span><br><span class="line">  <span class="attr">set:</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">  <span class="attr">map:</span> &#123; <span class="attr">k1:</span> <span class="string">v1</span>, <span class="attr">k2:</span> <span class="string">v2</span> &#125;</span><br><span class="line">  <span class="attr">positions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ITDragon</span></span><br><span class="line">      <span class="attr">salary:</span> <span class="number">15000.00</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ITDragonBlog</span></span><br><span class="line">      <span class="attr">salary:</span> <span class="number">18888.88</span></span><br></pre></td></tr></table></figure>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ul>
<li>字符串可以不加引号，若加双引号则输出特殊字符，若不加或加单引号则转义特殊字</li>
<li>数组类型，短横线后面要有空格；对象类型，冒号后面要有空格。</li>
<li>YAML 是以空格缩进的程度来控制层级关系，但不能用 tab 键代替空格，大小写敏</li>
<li>如何让一个程序员崩溃？在 yml 文件中加几个空格！(〃＞皿＜)</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/40a3c0c38dec4c618bc034441425e810/" data-id="ckmcqox35003a0kuv8b1afxh1" data-title="配置文件 yml" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-75b7b44fa66d461ba8a7ae3c8dadc2a9" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/75b7b44fa66d461ba8a7ae3c8dadc2a9/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/75b7b44fa66d461ba8a7ae3c8dadc2a9/">Java 中 String 转 LocalDateTime 出现错误</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在 Java 中使用 <code>LocalDateTime</code> 解析 <code>String</code> 失败</p>
<p>代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> LocalDateTime result = LocalDateTime.parse(<span class="string">&quot;2000-01-01&quot;</span>, DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd&quot;</span>));</span><br><span class="line">log.info(<span class="string">&quot;result: &#123;&#125;&quot;</span>, result);</span><br></pre></td></tr></table></figure>
<p>抛出异常</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.time.format.DateTimeParseException: Text <span class="string">&#x27;2000-01-01&#x27;</span> could not be parsed: Unable to obtain LocalDateTime from TemporalAccessor: &#123;&#125;,ISO resolved to 2000-01-01 of <span class="built_in">type</span> java.time.format.Parsed</span><br></pre></td></tr></table></figure>
<p>吾辈也在 <a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000018526018">SegmentFault</a> 上提出了这个问题，然而直到写出这篇记录时然而没有人告诉吾辈答案。。。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="先转换为-LocalDate-再二次转换"><a href="#先转换为-LocalDate-再二次转换" class="headerlink" title="先转换为 LocalDate 再二次转换"></a>先转换为 LocalDate 再二次转换</h3><p>吾辈首先找到了一种笨方法</p>
<ol>
<li> 先解析为 <code>LocalDate</code></li>
<li> 将 <code>LocalDate</code> 转换为 <code>LocalDateTime</code>。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> LocalDateTime localDateTime = LocalDate.parse(<span class="string">&quot;2018-12-11&quot;</span>, DateTimeFormatter.ISO_DATE).atStartOfDay();</span><br><span class="line">assertThat(localDateTime)</span><br><span class="line">    .isNotNull();</span><br></pre></td></tr></table></figure>
<h3 id="使用-DateTimeFormatter-先解析，然后转换为-LocalDateTime"><a href="#使用-DateTimeFormatter-先解析，然后转换为-LocalDateTime" class="headerlink" title="使用 DateTimeFormatter 先解析，然后转换为 LocalDateTime"></a>使用 DateTimeFormatter 先解析，然后转换为 LocalDateTime</h3><ol>
<li> 使用 <code>DateTimeFormatter.ISO_DATE</code> 解析文本并得到 <code>TemporalAccessor</code> 对象</li>
<li> 使用 <code>temporalAccessor.get</code> 方法获取指定属性</li>
<li> 使用 <code>LocalDateTime.of</code> 构造一个 <code>LocalDateTime</code> 对象</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> TemporalAccessor temporalAccessor = DateTimeFormatter.ISO_DATE.parse(<span class="string">&quot;2018-12-11&quot;</span>);</span><br><span class="line"><span class="keyword">final</span> LocalDateTime localDateTime = LocalDateTime.of(</span><br><span class="line">    secureGet(temporalAccessor, ChronoField.YEAR),</span><br><span class="line">    secureGet(temporalAccessor, ChronoField.MONTH_OF_YEAR),</span><br><span class="line">    secureGet(temporalAccessor, ChronoField.DAY_OF_MONTH),</span><br><span class="line">    secureGet(temporalAccessor, ChronoField.HOUR_OF_DAY),</span><br><span class="line">    secureGet(temporalAccessor, ChronoField.MINUTE_OF_HOUR),</span><br><span class="line">    secureGet(temporalAccessor, ChronoField.SECOND_OF_MINUTE),</span><br><span class="line">    secureGet(temporalAccessor, ChronoField.NANO_OF_SECOND)</span><br><span class="line">);</span><br><span class="line">log.info(<span class="string">&quot;localDateTime: &#123;&#125;&quot;</span>, localDateTime);</span><br></pre></td></tr></table></figure>
<p><code>secureGet</code> 是吾辈自定义的一个工具方法，具体看下面的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 安全获取时间的某个属性</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> temporalAccessor 需要获取的时间对象</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> chronoField      需要获取的属性</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> 时间的值，如果无法获取则默认为 0</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">secureGet</span><span class="params">(TemporalAccessor temporalAccessor, ChronoField chronoField)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (temporalAccessor.isSupported(chronoField)) &#123;</span><br><span class="line">        <span class="keyword">return</span> temporalAccessor.get(chronoField);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用-DateTimeFormatterBuilder-构建器"><a href="#使用-DateTimeFormatterBuilder-构建器" class="headerlink" title="使用 DateTimeFormatterBuilder 构建器"></a>使用 DateTimeFormatterBuilder 构建器</h3><p>吾辈在 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/27454025">StackOverflow</a> 找到了一个好的方法</p>
<ol>
<li> 使用 <code>DateTimeFormatterBuilder</code> 构建 <code>DateTimeFormatter</code> 对象</li>
<li> 赋予可选匹配项默认值（<strong>非常重要</strong>）</li>
<li> 使用 <code>LocalDateTime.parse</code> 进行解析</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> DateTimeFormatter formatter = <span class="keyword">new</span> DateTimeFormatterBuilder()</span><br><span class="line">    .appendPattern(<span class="string">&quot;yyyy-MM-dd[[&#x27;T&#x27;hh][:mm][:ss]]&quot;</span>)</span><br><span class="line">    .parseDefaulting(ChronoField.HOUR_OF_DAY, <span class="number">0</span>)</span><br><span class="line">    .parseDefaulting(ChronoField.MINUTE_OF_HOUR, <span class="number">0</span>)</span><br><span class="line">    .parseDefaulting(ChronoField.SECOND_OF_MINUTE, <span class="number">0</span>)</span><br><span class="line">    .parseDefaulting(ChronoField.MILLI_OF_SECOND, <span class="number">0</span>)</span><br><span class="line">    .toFormatter();</span><br><span class="line"><span class="keyword">final</span> LocalDateTime localDateTime = LocalDateTime.parse(<span class="string">&quot;2018-12-11&quot;</span>, formatter);</span><br><span class="line">assertThat(localDateTime)</span><br><span class="line">    .isNotNull();</span><br></pre></td></tr></table></figure>
<hr>
<p>最后一种方法满足了吾辈的需求，所以，也便是在这里记录一下啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/75b7b44fa66d461ba8a7ae3c8dadc2a9/" data-id="ckmcqox3r004z0kuvbahb0q63" data-title="Java 中 String 转 LocalDateTime 出现错误" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-7afb8532f50945d49222448db4be21ff" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/7afb8532f50945d49222448db4be21ff/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/7afb8532f50945d49222448db4be21ff/">将 Mybatis/MongoDB 集成到 SpringBoot 中的示例</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h2><p>本文假设你已经了解或知道以下技能，尤其而且是勾选的内容。</p>
<ul>
<li>[x] Gradle</li>
<li>[x] SpringBoot</li>
<li>[x] Mybatis Plus</li>
<li>[x] MongoDB</li>
<li>[ ] SpringBoot MongoDB Data</li>
<li>[ ] H2DB</li>
<li>[ ] SpringTest</li>
</ul>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/rxliuli/spring-boot-mybatis-plus-mongo">GitHub 项目</a>, <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/872037f5/">Blog 教程</a></p>
</blockquote>
<p>需要同时使用 <code>Mybatis-Plus</code> 和 <code>MongoDB</code>，所以就去了解了一下如何集成它们。</p>
<h2 id="集成-Mybatis-Plus"><a href="#集成-Mybatis-Plus" class="headerlink" title="集成 Mybatis Plus"></a>集成 Mybatis Plus</h2><h3 id="创建-SpringBoot-项目"><a href="#创建-SpringBoot-项目" class="headerlink" title="创建 SpringBoot 项目"></a>创建 SpringBoot 项目</h3><p>使用 SpringIO 创建 SpringBoot 项目，初始依赖选择 <code>web</code>, <code>h2</code> 两个模块，gradle 配置如下</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;2.1.3.RELEASE&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply plugin: <span class="string">&#x27;io.spring.dependency-management&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">group</span> = <span class="string">&#x27;com.rxliuli.example&#x27;</span></span><br><span class="line">version = <span class="string">&#x27;0.0.1-SNAPSHOT&#x27;</span></span><br><span class="line"><span class="keyword">sourceCompatibility</span> = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">repositories</span> &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line">    runtimeOnly <span class="string">&#x27;com.h2database:h2&#x27;</span></span><br><span class="line">    testImplementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-test&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：数据库吾辈这里为了简单起见直接使用了 <code>H2DB</code>，真实项目中可能需要配置 <code>MySQL</code> 之类。为了简化项目依赖配置文件，所以使用了 Gradle 而非 Maven。</p>
</blockquote>
<h3 id="引入-Mybatis-Plus-和-MongoDB-依赖"><a href="#引入-Mybatis-Plus-和-MongoDB-依赖" class="headerlink" title="引入 Mybatis-Plus 和 MongoDB 依赖"></a>引入 Mybatis-Plus 和 MongoDB 依赖</h3><p>在 <code>build.gradle</code> 中引入 <code>mybatis-plus-boot-starter</code> 依赖</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation <span class="keyword">group</span>: <span class="string">&#x27;com.baomidou&#x27;</span>, name: <span class="string">&#x27;mybatis-plus-boot-starter&#x27;</span>, version: <span class="string">&#x27;3.0.7.1&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加测试数据库"><a href="#添加测试数据库" class="headerlink" title="添加测试数据库"></a>添加测试数据库</h3><p>在 <em>src/resources</em> 下创建两个 sql 文件 <code>schema-h2.sql</code> 和 <code>data-h2.sql</code>，简单的使用 <code>H2DB</code> 创建数据库/表并添加数据以供测试使用。</p>
<p>数据库结构：<code>schema-h2.sql</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> schema spring_boot_mybatis_plus_mongo;</span><br><span class="line">use spring_boot_mybatis_plus_mongo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_info (</span><br><span class="line">  id   <span class="type">bigint</span> <span class="keyword">primary</span> <span class="keyword">key</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  name <span class="type">varchar</span>(<span class="number">20</span>)        <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  age  tinyint            <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">  sex  bool               <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>数据库测试数据：<code>data-h2.sql</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use spring_boot_mybatis_plus_mongo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_info (id, name, age, sex) <span class="keyword">values</span> (<span class="number">1</span>, <span class="string">&#x27;rx&#x27;</span>, <span class="number">17</span>, <span class="literal">false</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_info (id, name, age, sex) <span class="keyword">values</span> (<span class="number">2</span>, <span class="string">&#x27;琉璃&#x27;</span>, <span class="number">18</span>, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<h3 id="配置-Mybatis-Plus"><a href="#配置-Mybatis-Plus" class="headerlink" title="配置 Mybatis Plus"></a>配置 Mybatis Plus</h3><p>在 <code>application.yml</code> 中添加数据源配置</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DataSource Config</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.h2.Driver</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">classpath*:db/schema-h2.sql</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">classpath*:db/data-h2.sql</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:test</span></span><br></pre></td></tr></table></figure>
<h3 id="添加一些实体-Dao-Service"><a href="#添加一些实体-Dao-Service" class="headerlink" title="添加一些实体/Dao/Service"></a>添加一些实体/Dao/Service</h3><p>用户信息实体类：<code>com.rxliuli.example.springbootmybatisplusmongo.entity.UserInfo</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableName(&quot;user_info&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@TableId</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@TableField</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@TableField</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="meta">@TableField</span></span><br><span class="line">    <span class="keyword">private</span> Boolean sex;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserInfo</span><span class="params">(Long id, String name, Integer age, Boolean sex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.sex = sex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter()/setter()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户信息 Dao：<code>com.rxliuli.example.springbootmybatisplusmongo.dao.UserInfoDao</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoDao</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">UserInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户信息业务接口：<code>com.rxliuli.example.springbootmybatisplusmongo.service.UserInfoService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">UserInfo</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户信息业务接口实现类：<code>com.rxliuli.example.springbootmybatisplusmongo.service.impl.UserInfoServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">UserInfoDao</span>, <span class="title">UserInfo</span>&gt; <span class="keyword">implements</span> <span class="title">UserInfoService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置-Mybatis-Plus-扫描的路径"><a href="#配置-Mybatis-Plus-扫描的路径" class="headerlink" title="配置 Mybatis Plus 扫描的路径"></a>配置 Mybatis Plus 扫描的路径</h3><p>在启动类配置 <code>Mybatis Plus</code>，这点非常重要，以致于吾辈要单独列出，可能会出现的问题参见 <a href="@#%E8%B8%A9%E5%9D%91">踩坑</a> 部分</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.rxliuli.example.springbootmybatisplusmongo.**.dao.**&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootMybatisPlusMongoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootMybatisPlusMongoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试使用-Mybatis-Plus-的-UserInfoService"><a href="#测试使用-Mybatis-Plus-的-UserInfoService" class="headerlink" title="测试使用 Mybatis Plus 的 UserInfoService"></a>测试使用 Mybatis Plus 的 UserInfoService</h3><p>测试 Mybatis Plus 中 <code>IService</code> 接口的 <code>list()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;UserInfo&gt; list = userInfoService.list();</span><br><span class="line">        assertThat(list)</span><br><span class="line">                .isNotEmpty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="集成-MongoDB"><a href="#集成-MongoDB" class="headerlink" title="集成 MongoDB"></a>集成 MongoDB</h2><h3 id="引入-MongoDB-Boot-Starter"><a href="#引入-MongoDB-Boot-Starter" class="headerlink" title="引入 MongoDB Boot Starter"></a>引入 MongoDB Boot Starter</h3><p>在 <code>build.gradle</code> 中引入 <code>spring-boot-starter-data-mongodb</code> 依赖</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-data-mongodb&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置-MongoDB"><a href="#配置-MongoDB" class="headerlink" title="配置 MongoDB"></a>配置 MongoDB</h3><p>在 <code>application.yml</code> 中添加 MongoDB 的配置，现在 <code>application.yaml</code> 应该变成了下面这样</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># DataSource Config</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.h2.Driver</span></span><br><span class="line">    <span class="attr">schema:</span> <span class="string">classpath*:db/schema-h2.sql</span></span><br><span class="line">    <span class="attr">data:</span> <span class="string">classpath*:db/data-h2.sql</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:h2:mem:test</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="comment"># Integration mongodb</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://XXX:XXX@XXX:XXX/XXX</span></span><br></pre></td></tr></table></figure>
<h3 id="添加-Repository"><a href="#添加-Repository" class="headerlink" title="添加 Repository"></a>添加 Repository</h3><p>定义一些简单操作的 Dao 接口：<code>com.rxliuli.example.springbootmybatisplusmongo.repository.UserInfoLogRepository</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoLogRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">UserInfoLog</span>, <span class="title">Long</span>&gt;, <span class="title">CustomUserInfoLogRepository</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 id 查询用户日志信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 查询的 id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户日志</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">UserInfoLog <span class="title">findUserInfoLogByIdEquals</span><span class="params">(Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>自定义更加复杂需求的 Dao 接口：<code>com.rxliuli.example.springbootmybatisplusmongo.repository.CustomUserInfoLogRepository</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CustomUserInfoLogRepository</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据一些参数查询用户信息列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userInfoLog 参数对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户信息列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;UserInfoLog&gt; <span class="title">listByParam</span><span class="params">(UserInfoLog userInfoLog)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体的实现类：<code>com.rxliuli.example.springbootmybatisplusmongo.repository.UserInfoLogRepositoryImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 数据仓库 &#123;<span class="doctag">@link</span> UserInfoLogRepository&#125; 的实现类，但请务必注意，实现类继承的是 &#123;<span class="doctag">@link</span> CustomUserInfoLogRepository&#125; 接口，而非本应该继承的接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoLogRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">CustomUserInfoLogRepository</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoOperations mongoOperations;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfoLog&gt; <span class="title">listByParam</span><span class="params">(UserInfoLog userInfoLog)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Criteria criteria = <span class="keyword">new</span> Criteria();</span><br><span class="line">        <span class="keyword">if</span> (userInfoLog.getUserId() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            criteria.and(<span class="string">&quot;userId&quot;</span>)</span><br><span class="line">                    .is(userInfoLog.getUserId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (userInfoLog.getLogTime() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            criteria.and(<span class="string">&quot;logTime&quot;</span>)</span><br><span class="line">                    .gte(userInfoLog.getLogTime());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (userInfoLog.getOperate() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            criteria.and(<span class="string">&quot;operate&quot;</span>)</span><br><span class="line">                    .regex(userInfoLog.getOperate());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mongoOperations.find(<span class="keyword">new</span> Query(criteria), UserInfoLog.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="配置-MongoDB-扫描的路径"><a href="#配置-MongoDB-扫描的路径" class="headerlink" title="配置 MongoDB 扫描的路径"></a>配置 MongoDB 扫描的路径</h3><p>修改启动类，添加 <code>@EnableMongoRepositories</code> 注解用以配置 MongoDB 扫描的 <code>Repository</code> 路径</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.rxliuli.example.springbootmybatisplusmongo.**.dao.**&quot;)</span></span><br><span class="line"><span class="meta">@EnableMongoRepositories(&quot;com.rxliuli.example.springbootmybatisplusmongo.**.repository.**&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootMybatisPlusMongoApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SpringBootMybatisPlusMongoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试使用-MongoDB-的-UserInfoLogRepository"><a href="#测试使用-MongoDB-的-UserInfoLogRepository" class="headerlink" title="测试使用 MongoDB 的 UserInfoLogRepository"></a>测试使用 MongoDB 的 UserInfoLogRepository</h3><ol>
<li> 测试 <code>UserInfoLogRepository</code> 中由 MongoDB Data 自动实现的 <code>findUserInfoLogByIdEquals()</code> 方法</li>
<li> 测试 <code>CustomUserInfoLogRepository</code> 中自定义复杂的 <code>listByParam()</code> 方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoLogRepositoryTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoLogRepository userInfoLogRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始数据，最开始要运行一次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        userInfoLogRepository.insert(Lists.newArrayList(</span><br><span class="line">                <span class="keyword">new</span> UserInfoLog(<span class="number">1L</span>, <span class="number">1L</span>, <span class="string">&quot;登录&quot;</span>, LocalDateTime.now()),</span><br><span class="line">                <span class="keyword">new</span> UserInfoLog(<span class="number">2L</span>, <span class="number">1L</span>, <span class="string">&quot;退出&quot;</span>, LocalDateTime.now()),</span><br><span class="line">                <span class="keyword">new</span> UserInfoLog(<span class="number">3L</span>, <span class="number">2L</span>, <span class="string">&quot;登录&quot;</span>, LocalDateTime.now()),</span><br><span class="line">                <span class="keyword">new</span> UserInfoLog(<span class="number">4L</span>, <span class="number">3L</span>, <span class="string">&quot;退出&quot;</span>, LocalDateTime.now())</span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUserInfoLogByIdEquals</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> UserInfoLog result = userInfoLogRepository.findUserInfoLogByIdEquals(<span class="number">1L</span>);</span><br><span class="line">        assertThat(result)</span><br><span class="line">                .isNotNull();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listByParam</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> UserInfoLog userInfoLog = <span class="keyword">new</span> UserInfoLog(<span class="keyword">null</span>, <span class="number">1L</span>, <span class="string">&quot;登&quot;</span>,</span><br><span class="line">                LocalDateTime.parse(<span class="string">&quot;2019-02-22T08:22:16.000Z&quot;</span>, DateTimeFormatter.ISO_DATE_TIME));</span><br><span class="line">        <span class="keyword">final</span> List&lt;UserInfoLog&gt; result = userInfoLogRepository.listByParam(userInfoLog);</span><br><span class="line">        assertThat(result)</span><br><span class="line">                .isNotEmpty()</span><br><span class="line">                .allMatch(log -&gt;</span><br><span class="line">                        Objects.equals(userInfoLog.getUserId(), log.getUserId())</span><br><span class="line">                                &amp;&amp; log.getOperate().contains(userInfoLog.getOperate())</span><br><span class="line">                                &amp;&amp; log.getLogTime().isAfter(userInfoLog.getLogTime())</span><br><span class="line">                );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="同时使用-Mybatis-Dao-和-MongoDB-Repository"><a href="#同时使用-Mybatis-Dao-和-MongoDB-Repository" class="headerlink" title="同时使用 Mybatis Dao 和 MongoDB Repository"></a>同时使用 Mybatis Dao 和 MongoDB Repository</h2><h3 id="在-Service-中添加方法"><a href="#在-Service-中添加方法" class="headerlink" title="在 Service 中添加方法"></a>在 Service 中添加方法</h3><p>用户信息业务接口：<code>com.rxliuli.example.springbootmybatisplusmongo.service.UserInfoService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserInfoService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">UserInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户信息与用户日志的映射表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 以 &#123;<span class="doctag">@link</span> UserInfo&#125; -&gt; &#123;<span class="doctag">@link</span> List&lt;UserInfoLog&gt;&#125; 形式的 &#123;<span class="doctag">@link</span> Map&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Map&lt;UserInfo, List&lt;UserInfoLog&gt;&gt; listUserInfoAndLogMap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用户信息业务接口实现类：<code>com.rxliuli.example.springbootmybatisplusmongo.service.impl.UserInfoServiceImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">UserInfoDao</span>, <span class="title">UserInfo</span>&gt; <span class="keyword">implements</span> <span class="title">UserInfoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoLogRepository userInfoLogRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;UserInfo, List&lt;UserInfoLog&gt;&gt; listUserInfoAndLogMap() &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;UserInfo&gt; userInfoList = list();</span><br><span class="line">        <span class="keyword">final</span> List&lt;UserInfoLog&gt; userInfoLogList = userInfoLogRepository.findAll();</span><br><span class="line">        <span class="keyword">final</span> Map&lt;Long, List&lt;UserInfoLog&gt;&gt; map = userInfoLogList.stream().collect(Collectors.groupingBy(UserInfoLog::getUserId));</span><br><span class="line">        <span class="keyword">return</span> userInfoList.stream()</span><br><span class="line">                .collect(Collectors.toMap(user -&gt; user, user -&gt; map.getOrDefault(user.getId(), Collections.emptyList())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="添加简单的-RestAPI-进行测试"><a href="#添加简单的-RestAPI-进行测试" class="headerlink" title="添加简单的 RestAPI 进行测试"></a>添加简单的 RestAPI 进行测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/user-info&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserInfoApi</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserInfoService userInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;UserInfo&gt; <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userInfoService.list();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list-user-info-and-log-map&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;UserInfoLog&gt;&gt; listUserInfoAndLogMap() &#123;</span><br><span class="line">        <span class="keyword">return</span> userInfoService.listUserInfoAndLogMap().entrySet().stream()</span><br><span class="line">                .collect(Collectors.toMap(kv -&gt; JsonUtil.toJson(kv.getKey()), Map.Entry::getValue));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="测试-RestAPI"><a href="#测试-RestAPI" class="headerlink" title="测试 RestAPI"></a>测试 RestAPI</h3><p>现在，我们启动项目并打开浏览器，应当可以在以下地址看到对应的 JSON 数据</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="http://localhost:8080/api/user-info/list">用户信息列表</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;rx&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>: <span class="number">17</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot; 琉璃 &quot;</span>,</span><br><span class="line">    <span class="attr">&quot;age&quot;</span>: <span class="number">18</span>,</span><br><span class="line">    <span class="attr">&quot;sex&quot;</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li><p><a target="_blank" rel="noopener" href="http://localhost:8080/api/user-info/list-user-info-and-log-map">用户信息及对应日志映射表</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;&#123;\&quot;id\&quot;:\&quot;1\&quot;,\&quot;name\&quot;:\&quot;rx\&quot;,\&quot;age\&quot;:17,\&quot;sex\&quot;:false&#125;&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;userId&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;operate&quot;</span>: <span class="string">&quot; 登录 &quot;</span>,</span><br><span class="line">      <span class="attr">&quot;logTime&quot;</span>: <span class="string">&quot;2019-02-22T16:22:16.099&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;userId&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;operate&quot;</span>: <span class="string">&quot; 退出 &quot;</span>,</span><br><span class="line">      <span class="attr">&quot;logTime&quot;</span>: <span class="string">&quot;2019-02-22T16:22:16.099&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;&#123;\&quot;id\&quot;:\&quot;2\&quot;,\&quot;name\&quot;:\&quot;琉璃 \&quot;,\&quot;age\&quot;:18,\&quot;sex\&quot;:false&#125;&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;userId&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;operate&quot;</span>: <span class="string">&quot; 登录 &quot;</span>,</span><br><span class="line">      <span class="attr">&quot;logTime&quot;</span>: <span class="string">&quot;2019-02-22T16:22:16.099&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2></li>
</ul>
<ol>
<li><p>Mybatis Plus 扫包范围<br> 使用 <code>@MapperScan</code> 限制 Mybatis Plus 扫描 <code>Dao</code> 的范围，注意不要扫到 MongoDB 的 <code>Repository</code>，否则会抛出异常</p>
 <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: org.springframework.beans.factory.support.BeanDefinitionOverrideException: Invalid bean definition with name &#x27;userInfoLogRepository&#x27; defined in null: Cannot register bean definition [Root bean: class [org.springframework.data.mongodb.repository.support.MongoRepositoryFactoryBean]; scope=; abstract=false; lazyInit=false; autowireMode=0; dependencyCheck=0; autowireCandidate=true; primary=false; factoryBeanName=null; factoryMethodName=null; initMethodName=null; destroyMethodName=null] for bean &#x27;userInfoLogRepository&#x27;: There is already [Generic bean: class [org.mybatis.spring.mapper.MapperFactoryBean]; scope=singleton; abstract=false; lazyInit=false; autowireMode=2; dependencyCheck=0; autowireCandidate=true; primary=false; factoryBeanName=null; factoryMethodName=null; initMethodName=null; destroyMethodName=null; defined in file [D:\Text\spring-boot\spring-boot-mybatis-plus-mongo\out\production\classes\com\rxliuli\example\springbootmybatisplusmongo\repository\UserInfoLogRepository.class]] bound.</span><br></pre></td></tr></table></figure>
<p> 原因是在 SpringMongoData 处理之前 Mybatis Plus 先扫描到并进行了代理，然后就会告诉你无法注册 SpringMongoData 相关的 <code>Repository</code></p>
</li>
<li><p>使用 <code>@EnableMongoRepositories</code> 限制 SpringMongoData 扫描的范围</p>
<p> 既然说到限制，自然也不得不说一下 SpringMongoData 本身，如果你已经使用了 <code>@MapperScan</code> 扫描 Mybatis 需要处理的 Dao，那么添加与否并不重要。但是，吾辈要说但是了，但是，如果你先使用的 MongoDB，那么如果没有使用 <code>@MapperScan</code> 处理 Mybatis 的 Dao 的话，就会抛出以下异常，所以为了安全起见还是都定义了吧</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name <span class="string">&#x27;userInfoServiceImpl&#x27;</span>: Unsatisfied dependency expressed through field <span class="string">&#x27;baseMapper&#x27;</span>; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type <span class="string">&#x27;com.rxliuli.example.springbootmybatisplusmongo.dao.UserInfoDao&#x27;</span> available: expected at least <span class="number">1</span> bean which qualifies as autowire candidate. Dependency annotations: &#123;<span class="meta">@org</span>.springframework.beans.factory.annotation.Autowired(required=<span class="keyword">true</span>)&#125;</span><br></pre></td></tr></table></figure>
<p> 说的是自动注入 <code>BaseMapper</code> 失败，实际上是因为 Mybatis 的 Dao SpringMongoData 无法处理。</p>
</li>
<li><p>最好使用不同的后缀名区分 <code>Mybatis Mapper</code> 和 <code>Mongo Repository</code>，或者放到不同的包<br> 也是为了避免扫描混乱，出现 <code>Mybatis</code> 扫描到 <code>Mongo Repository</code> 或是 <code>Mongo</code> 扫描到 <code>Mybatis Mapper</code> 的情况，出现上面的那两个错误。</p>
</li>
</ol>
<hr>
<p>那么，关于在 SpringBoot 中同时使用 Mybatis Plus 和 MongoDB 的搭建就到这里啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/7afb8532f50945d49222448db4be21ff/" data-id="ckmcqox3u00590kuvehft8s35" data-title="将 Mybatis/MongoDB 集成到 SpringBoot 中的示例" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-7b7530bb8811483bae3a891a0b133ca7" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/7b7530bb8811483bae3a891a0b133ca7/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/7b7530bb8811483bae3a891a0b133ca7/">SpringMVC @RequestParam 参数不能自动转换泛型集合</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/rxliuli/springmvc-not-generic-param-example">GitHub example</a></p>
</blockquote>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>在使用 SpringMVC 传参的时候遇到的一个问题，本来需要的参数类型是 <code>Map&lt;Integer, Integer&gt;l</code>。然而浏览器传递过来的是 <code>Map&lt;String, String&gt;</code>。然而，此时 SpringMVC 并没有直接说参数类型错误。</p>
<p>Controller 大概是下面这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeApi</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;testMap&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Integer, Integer&gt; <span class="title">testMap</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;Integer, Integer&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 简单的打印 map</span></span><br><span class="line">        log.info(<span class="string">&quot;map: &#123;&#125;&quot;</span>, map);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然而，当吾辈调用这个接口时，却出现了错误</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fd = <span class="keyword">new</span> FormData();</span><br><span class="line">fd.append(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">fd.append(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">fd.append(<span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line">fetch(<span class="string">&quot;/testMap&quot;</span>, &#123;</span><br><span class="line">  method: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">  body: fd,</span><br><span class="line">&#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">res</span>) =&gt;</span> res.json())</span><br><span class="line">  .then(<span class="function">(<span class="params">json</span>) =&gt;</span> <span class="built_in">console</span>.log(json));</span><br></pre></td></tr></table></figure>
<p>报错信息</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2019-01-17T09:59:16.809+0000&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;status&quot;</span>: <span class="number">500</span>,</span><br><span class="line">  <span class="attr">&quot;error&quot;</span>: <span class="string">&quot;Internal Server Error&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;Could not write JSON: java.lang.String cannot be cast to java.lang.Number; nested exception is com.fasterxml.jackson.databind.JsonMappingException: java.lang.String cannot be cast to java.lang.Number&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;/testMap&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，Spring 告诉我们，不能转换 <code>String</code> 为 <code>Integer</code>。这是为什么呢？让我们来调试一下！</p>
<p>可以看到，确实进入了方法，然而最后一步却报错了<br><img src="https://img.rxliuli.com/20190117180704.png" alt="进入了方法"></p>
<p>报错原因</p>
<ul>
<li>泛型只在编译期有约束，运行时泛型实际并不存在，所以可以进入方法而非出现参数错误</li>
<li>最终转换类型为 <code>Map&lt;Integer, Integer&gt;</code> 的时候发现类型错误</li>
</ul>
<p>那么，我们是否可以手动将之转换为 <code>Map&lt;Integer, Integer&gt;</code> 呢？修改代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeApi</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;testMap&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Integer, Integer&gt; <span class="title">testMap</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;Integer, Integer&gt; map)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;map: &#123;&#125;&quot;</span>, map);</span><br><span class="line">        <span class="keyword">return</span> map.entrySet().stream().collect(Collectors.toMap(kv -&gt; Integer.parseInt(kv.getKey()), kv -&gt; Integer.parseInt(kv.getValue())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次调用，发现在 <code>kv.getKey()</code> 这里就已经发生了异常。那么，我们应该如何解决呢？</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="使用-Map-lt-String-String-gt"><a href="#使用-Map-lt-String-String-gt" class="headerlink" title="使用 Map&lt;String, String&gt;"></a>使用 <code>Map&lt;String, String&gt;</code></h3><p>其实，我们只要将参数类型声明为 <code>Map&lt;String, String&gt;</code>，然后再手动转换即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeApi</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;testMap&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Integer, Integer&gt; <span class="title">testMap</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, String&gt; map)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;map: &#123;&#125;&quot;</span>, map);</span><br><span class="line">        <span class="keyword">return</span> map.entrySet().stream().collect(Collectors.toMap(kv -&gt; Integer.parseInt(kv.getKey()), kv -&gt; Integer.parseInt(kv.getValue())));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再次调用，一切恢复了正常！</p>
<h3 id="使用-RequestBody"><a href="#使用-RequestBody" class="headerlink" title="使用 @RequestBody"></a>使用 <code>@RequestBody</code></h3><p>除此之外，我们或许还有另外一种方法，使用支持泛型的参数的 <code>@RequestBody</code> 标识为 <code>json</code> 参数。修改代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HomeApi</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;testMap&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Integer, Integer&gt; <span class="title">testMap</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;Integer, Integer&gt; map)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;map: &#123;&#125;&quot;</span>, map);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时，客户端也要修改为以 <code>json</code> 的形式，将参数传递给服务端</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">&quot;/testMap&quot;</span>, &#123;</span><br><span class="line">  method: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">  body: <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">    <span class="number">1</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="number">3</span>,</span><br><span class="line">  &#125;),</span><br><span class="line">  headers: &#123;</span><br><span class="line">    <span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line">  .then(<span class="function">(<span class="params">res</span>) =&gt;</span> res.json())</span><br><span class="line">  .then(<span class="function">(<span class="params">json</span>) =&gt;</span> <span class="built_in">console</span>.log(json));</span><br></pre></td></tr></table></figure>
<hr>
<p>那么，关于 SpringMVC 不能自动转换泛型集合便到这里就结束啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/7b7530bb8811483bae3a891a0b133ca7/" data-id="ckmcqox3v005c0kuv3ed8ez2s" data-title="SpringMVC @RequestParam 参数不能自动转换泛型集合" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-82bfd9d4a02e400a91ac917ac034cccb" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/82bfd9d4a02e400a91ac917ac034cccb/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/82bfd9d4a02e400a91ac917ac034cccb/">MySQL 行列转换</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>面试的时候遇到的一个问题，之前没有碰到过这种场景，所以却是无论如何都回答不了呢！然而本着遇到的坑跌倒过一次就够了的理念，回来时吾辈稍微 Google 了一下这个问题，结果便在此记录一下好啦</p>
<h2 id="行转列"><a href="#行转列" class="headerlink" title="行转列"></a>行转列</h2><p>指的是将数据行根据状态区分为不同的列，主要应用场景应该是统计报表吧</p>
<p>例如下面这个 <code>exam</code> 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> exam;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> exam (</span><br><span class="line">  name    <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  subject <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;考试科目&#x27;</span>,</span><br><span class="line">  score   <span class="type">int</span>         <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;考试成绩&#x27;</span></span><br><span class="line">)</span><br><span class="line">  comment <span class="string">&#x27;考试记录&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;琉璃&#x27;</span>, <span class="string">&#x27;语文&#x27;</span>, <span class="number">90</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;琉璃&#x27;</span>, <span class="string">&#x27;英语&#x27;</span>, <span class="number">85</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;楚轩&#x27;</span>, <span class="string">&#x27;数学&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;楚轩&#x27;</span>, <span class="string">&#x27;物理&#x27;</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;化学&#x27;</span>, <span class="number">40</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam <span class="keyword">values</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;生物&#x27;</span>, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
<p>直接查询会是下面这个样子</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>科目</th>
<th>分数</th>
</tr>
</thead>
<tbody><tr>
<td>琉璃</td>
<td>语文</td>
<td>90</td>
</tr>
<tr>
<td>琉璃</td>
<td>英语</td>
<td>85</td>
</tr>
<tr>
<td>楚轩</td>
<td>数学</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>物理</td>
<td>100</td>
</tr>
<tr>
<td>张三</td>
<td>化学</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>生物</td>
<td>100</td>
</tr>
</tbody></table>
<p>然而需要的结果却是</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>语文</th>
<th>数学</th>
<th>英语</th>
<th>物理</th>
<th>化学</th>
<th>生物</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>40</td>
<td>0</td>
</tr>
<tr>
<td>李四</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>楚轩</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>琉璃</td>
<td>90</td>
<td>0</td>
<td>85</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<p>大致的实现思路是判断 <code>subject</code> 的值，如果等于 <code>转换列</code> 的值，就将之设置为该 <code>转换列</code> 的值。（此处的 <code>转换列</code> 指的是根据 <code>subject</code> 的值查询的新列）</p>
<p>目前网络上能找到的方法有下面两种</p>
<h3 id="使用-if-实现行转列"><a href="#使用-if-实现行转列" class="headerlink" title="使用 if 实现行转列"></a>使用 if 实现行转列</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name                              <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;物理&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;化学&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;生物&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;生物&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p>优点：简单方便，即便是将几列合并也可以简单做到。例如我们想要统计主科/副科的总分</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name                                                                  <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">sum</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span> <span class="keyword">or</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span> <span class="keyword">or</span> subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;主科&#x27;</span>,</span><br><span class="line">  <span class="built_in">sum</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;物理&#x27;</span> <span class="keyword">or</span> subject <span class="operator">=</span> <span class="string">&#x27;化学&#x27;</span> <span class="keyword">or</span> subject <span class="operator">=</span> <span class="string">&#x27;生物&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;副科&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p>查询结果</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>主科</th>
<th>副科</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>0</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>100</td>
<td>100</td>
</tr>
<tr>
<td>琉璃</td>
<td>250</td>
<td>0</td>
</tr>
</tbody></table>
<p>或者简单的实现小计</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  <span class="comment">-- 这里的 ifnull 其实是为了让最后一行的统计不为 null</span></span><br><span class="line">  ifnull(name, <span class="string">&#x27;total&#x27;</span>)             <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;物理&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;化学&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(if(subject <span class="operator">=</span> <span class="string">&#x27;生物&#x27;</span>, score, <span class="number">0</span>)) <span class="keyword">as</span> <span class="string">&#x27;生物&#x27;</span>,</span><br><span class="line">  <span class="comment">-- 统计每一行数据</span></span><br><span class="line">  <span class="built_in">sum</span>(score)                        <span class="keyword">as</span> total</span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="comment">-- 按照 name 进行分组并进行小计</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name <span class="keyword">with</span> <span class="keyword">rollup</span>;</span><br></pre></td></tr></table></figure>
<p>查询结果</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>语文</th>
<th>数学</th>
<th>英语</th>
<th>物理</th>
<th>化学</th>
<th>生物</th>
<th>total</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>40</td>
<td>0</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>100</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>0</td>
<td>200</td>
</tr>
<tr>
<td>琉璃</td>
<td>90</td>
<td>0</td>
<td>85</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>250</td>
</tr>
<tr>
<td>total</td>
<td>90</td>
<td>100</td>
<td>85</td>
<td>100</td>
<td>40</td>
<td>100</td>
<td>590</td>
</tr>
</tbody></table>
<h3 id="使用-case-when-实现行转列"><a href="#使用-case-when-实现行转列" class="headerlink" title="使用 case when 实现行转列"></a>使用 case when 实现行转列</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;语文&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;数学&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;英语&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;物理&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;化学&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  <span class="built_in">max</span>(<span class="keyword">case</span> subject <span class="keyword">when</span> <span class="string">&#x27;生物&#x27;</span> <span class="keyword">then</span> score <span class="keyword">else</span> <span class="number">0</span> <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;生物&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p>优点：相比于 <code>if</code> 更加灵活，可以对每个 <code>转换列</code> 的值进行单独的处理。例如我们想要统计主科/副科的总分，并设置计算语文/数学时增加一半，而英语的分数则忽略不计</p>
<blockquote>
<p>感觉这个优势相当的小，当然如果用到的话却是无需多言的</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name     <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="built_in">sum</span>(<span class="keyword">case</span> subject</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;语文&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score <span class="operator">*</span> <span class="number">1.5</span></span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;数学&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score <span class="operator">*</span> <span class="number">1.5</span></span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;英语&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> <span class="number">0</span></span><br><span class="line">      <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">      <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;主科&#x27;</span>,</span><br><span class="line">  <span class="built_in">sum</span>(<span class="keyword">case</span> subject</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;物理&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;化学&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score</span><br><span class="line">      <span class="keyword">when</span> <span class="string">&#x27;生物&#x27;</span></span><br><span class="line">        <span class="keyword">then</span> score</span><br><span class="line">      <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">      <span class="keyword">end</span>) <span class="keyword">as</span> <span class="string">&#x27;副科&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p>查询结果</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>主科</th>
<th>副科</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0.0</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>0.0</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>150.0</td>
<td>100</td>
</tr>
<tr>
<td>琉璃</td>
<td>247.5</td>
<td>0</td>
</tr>
</tbody></table>
<h3 id="使用子查询实现行转列"><a href="#使用子查询实现行转列" class="headerlink" title="使用子查询实现行转列"></a>使用子查询实现行转列</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  if(<span class="keyword">language</span> <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, <span class="keyword">language</span>, <span class="number">0</span>)       <span class="keyword">as</span> <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  if(mathematics <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, mathematics, <span class="number">0</span>) <span class="keyword">as</span> <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  if(english <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, english, <span class="number">0</span>)         <span class="keyword">as</span> <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  if(physical <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, physical, <span class="number">0</span>)       <span class="keyword">as</span> <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  if(chemistry <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, chemistry, <span class="number">0</span>)     <span class="keyword">as</span> <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  if(biological <span class="operator">!=</span> <span class="string">&#x27;null&#x27;</span>, biological, <span class="number">0</span>)   <span class="keyword">as</span> <span class="string">&#x27;生物&#x27;</span></span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line">       <span class="keyword">select</span></span><br><span class="line">         e.name,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;语文&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> <span class="keyword">language</span>,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;数学&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> mathematics,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;英语&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> english,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;物理&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> physical,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;化学&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> chemistry,</span><br><span class="line">         (<span class="keyword">select</span> e1.score <span class="keyword">from</span> exam e1 <span class="keyword">where</span> subject <span class="operator">=</span> <span class="string">&#x27;生物&#x27;</span> <span class="keyword">and</span> e1.name <span class="operator">=</span> e.name limit <span class="number">1</span>) <span class="keyword">as</span> biological</span><br><span class="line">       <span class="keyword">from</span> exam e</span><br><span class="line">       <span class="keyword">group</span> <span class="keyword">by</span> name</span><br><span class="line">     ) temp;</span><br></pre></td></tr></table></figure>
<p>优点：使用起来最灵活，但代码量也是最大的。可以对每一个列的多条/单条数据进行单独的处理，不需要必须使用统计函数（<code>sum/avg/max/min/count</code>）。例如上面就是如果查到了多条数据就直接取第一条，当然也可以对第一条数据做后续处理。</p>
<h3 id="使用-group-concat-简单的行连接"><a href="#使用-group-concat-简单的行连接" class="headerlink" title="使用 group_concat 简单的行连接"></a>使用 group_concat 简单的行连接</h3><p>并非是真正的行转列，实际上只是把不同字段的数据 <em>连接</em> 了起来</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name                              <span class="keyword">as</span> <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  group_concat(subject, <span class="string">&#x27; &#x27;</span>, score) <span class="keyword">as</span> <span class="string">&#x27;成绩单&#x27;</span></span><br><span class="line"><span class="keyword">from</span> exam</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> name;</span><br></pre></td></tr></table></figure>
<p>查询结果</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>成绩单</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>化学 40</td>
</tr>
<tr>
<td>李四</td>
<td>生物 100</td>
</tr>
<tr>
<td>楚轩</td>
<td>数学 100,物理 100</td>
</tr>
<tr>
<td>琉璃</td>
<td>语文 75,语文 90,英语 85</td>
</tr>
</tbody></table>
<h2 id="列转行"><a href="#列转行" class="headerlink" title="列转行"></a>列转行</h2><p>将类似的列按照某种规则变成一列，并生成等同倍数的行。</p>
<p>我们需要将上面行转列得到的表转换回来，例如下面的 <code>exam_score</code> 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> exam_score (</span><br><span class="line">  name        <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;姓名&#x27;</span>,</span><br><span class="line">  <span class="keyword">language</span>    <span class="type">int</span>         <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;语文&#x27;</span>,</span><br><span class="line">  mathematics <span class="type">int</span>         <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;数学&#x27;</span>,</span><br><span class="line">  english     <span class="type">int</span>         <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;英语&#x27;</span>,</span><br><span class="line">  physical    <span class="type">int</span>         <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;物理&#x27;</span>,</span><br><span class="line">  chemistry   <span class="type">int</span>         <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;化学&#x27;</span>,</span><br><span class="line">  biological  <span class="type">int</span>         <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">  comment <span class="string">&#x27;生物&#x27;</span></span><br><span class="line">)</span><br><span class="line">  comment <span class="string">&#x27;考试成绩&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam_score (name, <span class="keyword">language</span>, mathematics, english, physical, chemistry, biological)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam_score (name, <span class="keyword">language</span>, mathematics, english, physical, chemistry, biological)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam_score (name, <span class="keyword">language</span>, mathematics, english, physical, chemistry, biological)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;楚轩&#x27;</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> exam_score (name, <span class="keyword">language</span>, mathematics, english, physical, chemistry, biological)</span><br><span class="line"><span class="keyword">values</span> (<span class="string">&#x27;琉璃&#x27;</span>, <span class="number">90</span>, <span class="number">0</span>, <span class="number">85</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>直接查询结果是</p>
<table>
<thead>
<tr>
<th>name</th>
<th>language</th>
<th>mathematics</th>
<th>english</th>
<th>physical</th>
<th>chemistry</th>
<th>biological</th>
</tr>
</thead>
<tbody><tr>
<td>张三</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>40</td>
<td>0</td>
</tr>
<tr>
<td>李四</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>100</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>琉璃</td>
<td>90</td>
<td>0</td>
<td>85</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<p>然而我们需要得到</p>
<table>
<thead>
<tr>
<th>姓名</th>
<th>科目</th>
<th>分数</th>
</tr>
</thead>
<tbody><tr>
<td>琉璃</td>
<td>语文</td>
<td>90</td>
</tr>
<tr>
<td>琉璃</td>
<td>英语</td>
<td>85</td>
</tr>
<tr>
<td>楚轩</td>
<td>数学</td>
<td>100</td>
</tr>
<tr>
<td>楚轩</td>
<td>物理</td>
<td>100</td>
</tr>
<tr>
<td>张三</td>
<td>化学</td>
<td>40</td>
</tr>
<tr>
<td>李四</td>
<td>生物</td>
<td>100</td>
</tr>
</tbody></table>
<h3 id="使用-union-all-联合查询"><a href="#使用-union-all-联合查询" class="headerlink" title="使用 union all 联合查询"></a>使用 union all 联合查询</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;语文&#x27;</span>     <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  <span class="keyword">language</span> <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">language</span> <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;数学&#x27;</span>        <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  mathematics <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> mathematics <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;英语&#x27;</span>    <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  english <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> english <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;物理&#x27;</span>     <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  physical <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> physical <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;化学&#x27;</span>      <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  chemistry <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> chemistry <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">  name,</span><br><span class="line">  <span class="string">&#x27;生物&#x27;</span>       <span class="keyword">as</span> <span class="string">&#x27;subject&#x27;</span>,</span><br><span class="line">  biological <span class="keyword">as</span> score</span><br><span class="line"><span class="keyword">from</span> exam_score</span><br><span class="line"><span class="keyword">where</span> biological <span class="operator">!=</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>唔，好长的 sql 语句，这还只是 6 个 <code>转换列</code>，如果有更多的话恐怕。。。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="sql-行转列的问题"><a href="#sql-行转列的问题" class="headerlink" title="sql 行转列的问题"></a>sql 行转列的问题</h3><p>sql 的技巧确实很多，然而相比之下 sql 只是一门 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/SQL">结构化查询语言</a>，并不算是真正的编程语言呢！行转列/列转行这些需求放到真正的编程语言中是很容易处理的，下面演示使用 js 的实现</p>
<h3 id="使用-JavaScript-实现行转列"><a href="#使用-JavaScript-实现行转列" class="headerlink" title="使用 JavaScript 实现行转列"></a>使用 JavaScript 实现行转列</h3><p>假设有下面这样一个 json 数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;琉璃&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;语文&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;score&quot;</span>: <span class="number">75</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;琉璃&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;语文&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;score&quot;</span>: <span class="number">90</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;琉璃&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;英语&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;score&quot;</span>: <span class="number">85</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;楚轩&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;数学&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;score&quot;</span>: <span class="number">100</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;楚轩&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;物理&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;score&quot;</span>: <span class="number">100</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;化学&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;score&quot;</span>: <span class="number">40</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;李四&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;subject&quot;</span>: <span class="string">&quot;生物&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;score&quot;</span>: <span class="number">100</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>转换方法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 行转列</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Array&#125;</span> </span>arr 需要进行行转列的数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span> </span>行转列得到的数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rowToCol</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * js 数组按照某个条件进行分组</span></span><br><span class="line"><span class="comment">   * 注：分组完成后会得到一个二维数组，并且顺序会被打乱</span></span><br><span class="line"><span class="comment">   * 时间复杂度为 2On</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> <span class="type">&#123;fn&#125;</span> </span>元素分组的方法，默认使用 &#123;<span class="doctag">@link </span>JSON.stringify()&#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span> </span>新的数组</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">Array</span>.prototype.groupBy = <span class="function"><span class="keyword">function</span> (<span class="params">fn = (item) =&gt; <span class="built_in">JSON</span>.stringify(item)</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 将元素按照分组条件进行分组得到一个 条件 -&gt; 数组 的对象</span></span><br><span class="line">    <span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line">    <span class="built_in">this</span>.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> name = fn(item);</span><br><span class="line">      <span class="comment">// 如果已经有这个键了就直接追加, 否则先将之赋值为 [] 再追加元素</span></span><br><span class="line">      (obj[name] || (obj[name] = [])).push(item);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 将对象转换为数组</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.keys(obj).map(<span class="function">(<span class="params">key</span>) =&gt;</span> obj[key]);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * js 的数组去重方法</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="type">&#123;Function&#125;</span> <span class="type">&#123;fn&#125;</span> </span>唯一标识元素的方法，默认使用 &#123;<span class="doctag">@link </span>JSON.stringify()&#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span> </span>进行去重操作之后得到的新的数组 (原数组并未改变)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">Array</span>.prototype.uniqueBy = <span class="function"><span class="keyword">function</span> (<span class="params">fn = (item) =&gt; <span class="built_in">JSON</span>.stringify(item)</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> obj = &#123;&#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.filter(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> obj.hasOwnProperty(fn(item)) ? <span class="literal">false</span> : (obj[fn(item)] = <span class="literal">true</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取所有的科目 -&gt; 分数映射表</span></span><br><span class="line"><span class="comment">   * 看起来函数有点奇怪，但实际上只是一个闭包函数而已</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;Object&#125;</span> </span>所有的科目 -&gt; 分数映射表的拷贝</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">const</span> subjectMap = (<span class="function">(<span class="params">obj</span>) =&gt;</span> <span class="function">() =&gt;</span> <span class="built_in">Object</span>.assign(&#123;&#125;, obj))(</span><br><span class="line">    arr</span><br><span class="line">      .map(<span class="function">(<span class="params">row</span>) =&gt;</span> row.subject)</span><br><span class="line">      .uniqueBy()</span><br><span class="line">      .reduce(<span class="function">(<span class="params">res, subject</span>) =&gt;</span> &#123;</span><br><span class="line">        res[subject] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">      &#125;, &#123;&#125;)</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> arr</span><br><span class="line">    .groupBy(<span class="function">(<span class="params">row</span>) =&gt;</span> row.name)</span><br><span class="line">    .map(<span class="function">(<span class="params">arr</span>) =&gt;</span></span><br><span class="line">      arr</span><br><span class="line">        .uniqueBy(<span class="function">(<span class="params">row</span>) =&gt;</span> row.subject)</span><br><span class="line">        .reduce(<span class="function">(<span class="params">res, temp</span>) =&gt;</span> &#123;</span><br><span class="line">          res = <span class="built_in">Object</span>.assign(subjectMap(), res);</span><br><span class="line">          res.name = temp.name;</span><br><span class="line">          res[temp.subject] = temp.score;</span><br><span class="line">          <span class="keyword">return</span> res;</span><br><span class="line">        &#125;, &#123;&#125;)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起来好像更长了？但实际上 <code>groupBy()/uniqueBy()</code> 都是通用的函数，所以实际代码应该不超过 20 行。转换后的数据如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;语文&quot;</span>: <span class="number">75</span>,</span><br><span class="line">    <span class="attr">&quot;英语&quot;</span>: <span class="number">85</span>,</span><br><span class="line">    <span class="attr">&quot;数学&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;物理&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;化学&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;生物&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;琉璃&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;语文&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;英语&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;数学&quot;</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;物理&quot;</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;化学&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;生物&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;楚轩&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;语文&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;英语&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;数学&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;物理&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;化学&quot;</span>: <span class="number">40</span>,</span><br><span class="line">    <span class="attr">&quot;生物&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;张三&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;语文&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;英语&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;数学&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;物理&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;化学&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;生物&quot;</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;李四&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="使用-JavaScript-实现列转行"><a href="#使用-JavaScript-实现列转行" class="headerlink" title="使用 JavaScript 实现列转行"></a>使用 JavaScript 实现列转行</h3><p>那么，如何转换回来呢？转换回来的话却是简单许多了呢</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 列转行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Array&#125;</span> </span>arr 需要进行列转行的数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns <span class="type">&#123;Array&#125;</span> </span>列转行得到的数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">colToRow</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 定义好需要进行合并列的数组</span></span><br><span class="line">  <span class="keyword">var</span> cols = [<span class="string">&quot;语文&quot;</span>, <span class="string">&quot;英语&quot;</span>, <span class="string">&quot;数学&quot;</span>, <span class="string">&quot;物理&quot;</span>, <span class="string">&quot;化学&quot;</span>, <span class="string">&quot;生物&quot;</span>];</span><br><span class="line">  <span class="keyword">return</span> arr.flatMap(<span class="function">(<span class="params">row</span>) =&gt;</span></span><br><span class="line">    cols</span><br><span class="line">      .map(<span class="function">(<span class="params">subject</span>) =&gt;</span> (&#123;</span><br><span class="line">        name: row.name,</span><br><span class="line">        subject: subject,</span><br><span class="line">        score: row[subject],</span><br><span class="line">      &#125;))</span><br><span class="line">      .filter(<span class="function">(<span class="params">newRow</span>) =&gt;</span> newRow.score != <span class="number">0</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>那么，关于 MySQL 行列转换的问题就到这里啦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/82bfd9d4a02e400a91ac917ac034cccb/" data-id="ckmcqox3y005m0kuv51lxg4ky" data-title="MySQL 行列转换" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/" rel="tag">sql</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-8e5d9aba9ab845a9924c10565d53ecb7" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/8e5d9aba9ab845a9924c10565d53ecb7/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/8e5d9aba9ab845a9924c10565d53ecb7/">Windows 上安装 JDK 并设置环境变量</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="从-Oracle-官网下载-JDK"><a href="#从-Oracle-官网下载-JDK" class="headerlink" title="从 Oracle 官网下载 JDK"></a>从 Oracle 官网下载 JDK</h2><p>首先在浏览器打开 <a target="_blank" rel="noopener" href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html">JDK8 下载页面</a></p>
<p>找到 <strong>Java SE Development Kit 8uXXX</strong> 勾选 <strong>Accept License Agreement</strong>，点击下载平台对应的二进制文件，这里以 Windows 平台为例，选择 <strong>jdk-8u191-windows-x64.exe</strong> 下载就好了</p>
<p><img src="https://img.rxliuli.com/20181017141137.png" alt="JDK8 下载"></p>
<h2 id="运行安装程序"><a href="#运行安装程序" class="headerlink" title="运行安装程序"></a>运行安装程序</h2><p>双击打开 JDK 安装，其实基本上就是一路 Next 下去就好啦</p>
<p><img src="https://img.rxliuli.com/20181017145812.png" alt="JDK 安装 01"></p>
<p><img src="https://img.rxliuli.com/20181017145854.png" alt="JDK 安装 02"></p>
<p><img src="https://img.rxliuli.com/20181017145932.png" alt="JDK 安装 02"></p>
<p><img src="https://img.rxliuli.com/20181017150018.png" alt="JDK 安装 03"></p>
<p>这里需要注意一下，对于安装 JDK 的人来说，Java 安装是可有可无的，所以我们这里直接点 X 就好再确定就好。</p>
<p><img src="https://img.rxliuli.com/20181017150310.png" alt="不安装 Java"></p>
<p><img src="https://img.rxliuli.com/20181017150357.png" alt="安装完成"></p>
<p>安装完成，关闭安装窗口即可，然而我们并不能立刻开始使用 JDK，因为我们还需要设置 JDK 的环境变量</p>
<h2 id="设置-JDK-的环境变量"><a href="#设置-JDK-的环境变量" class="headerlink" title="设置 JDK 的环境变量"></a>设置 JDK 的环境变量</h2><ol>
<li> 在 <strong>此电脑</strong> 上右键选择 <strong>属性</strong></li>
</ol>
<p><img src="https://img.rxliuli.com/20181017142509.png" alt="此电脑右键属性"></p>
<ol start="2">
<li> 在 <strong>控制面板\系统和安全\系统</strong> 选择 <strong>高级系统设置</strong></li>
</ol>
<p><img src="https://img.rxliuli.com/20181017142726.png" alt="高级系统设置"></p>
<ol start="3">
<li> 在 <strong>系统属性 &gt; 高级</strong> 选项卡选择 <strong>环境变量</strong></li>
</ol>
<p><img src="https://img.rxliuli.com/20181017142652.png" alt="环境变量"></p>
<p>JDK：需要设置 3 个环境变量（如果找不到就添加）</p>
<blockquote>
<p>附：这里一般设置到 <strong>系统变量</strong> 里面</p>
</blockquote>
<p><img src="https://img.rxliuli.com/20181017143203.png" alt="环境变量设置"></p>
<ul>
<li><p>JAVA_HOME：浏览文件夹选择 JDK 安装路径就行了</p>
<p><img src="https://img.rxliuli.com/20181017143629.png" alt="JAVA_HOME 环境变量"></p>
</li>
<li><p>CLASSPATH：<code>.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;</code></p>
<p><img src="https://img.rxliuli.com/20181017144048.png" alt="CLASSPATH 环境变量"></p>
</li>
<li><p>Path：添加 <code>%JAVA_HOME%\bin</code> 和 <code>%JAVA_HOME%\jre\bin</code></p>
<p><img src="https://img.rxliuli.com/20181017143940.png" alt="Path 环境变量"></p>
</li>
</ul>
<p>设置完环境变量之后一定要按确定依次关闭 <strong>环境变量</strong>，<strong>系统属性</strong> 窗口</p>
<p>JDK 安装完成了，现在测试一下能否正常使用，使用 <code>Win + R</code> 输入 <code>cmd</code> 打开 CMD 命令行窗口，或者在菜单中找到 <em>Windows 系统 &gt; 命令提示符</em> 点击也同样能打开 CMD。</p>
<h2 id="测试-JDK-是否安装成功"><a href="#测试-JDK-是否安装成功" class="headerlink" title="测试 JDK 是否安装成功"></a>测试 JDK 是否安装成功</h2><p><img src="https://img.rxliuli.com/20181017145201.png" alt="在菜单中打开 CMD"></p>
<p>在命令行输入 <code>javac</code>，你应该得到类似于下面的这些输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">用法: javac &lt;options&gt; &lt;<span class="built_in">source</span> files&gt;</span><br><span class="line">其中, 可能的选项包括:</span><br><span class="line">  -g                         生成所有调试信息</span><br><span class="line">  -g:none                    不生成任何调试信息</span><br><span class="line">  -g:&#123;lines,vars,<span class="built_in">source</span>&#125;     只生成某些调试信息</span><br><span class="line">  -nowarn                    不生成任何警告</span><br><span class="line">  -verbose                   输出有关编译器正在执行的操作的消息</span><br><span class="line">  -deprecation               输出使用已过时的 API 的源位置</span><br><span class="line">  -classpath &lt;路径&gt;            指定查找用户类文件和注释处理程序的位置</span><br><span class="line">  -cp &lt;路径&gt;                   指定查找用户类文件和注释处理程序的位置</span><br><span class="line">  -sourcepath &lt;路径&gt;           指定查找输入源文件的位置</span><br><span class="line">  -bootclasspath &lt;路径&gt;        覆盖引导类文件的位置</span><br><span class="line">  -extdirs &lt;目录&gt;              覆盖所安装扩展的位置</span><br><span class="line">  -endorseddirs &lt;目录&gt;         覆盖签名的标准路径的位置</span><br><span class="line">  -proc:&#123;none,only&#125;          控制是否执行注释处理和/或编译。</span><br><span class="line">  -processor &lt;class1&gt;[,&lt;class2&gt;,&lt;class3&gt;...] 要运行的注释处理程序的名称; 绕过默认的搜索进程</span><br><span class="line">  -processorpath &lt;路径&gt;        指定查找注释处理程序的位置</span><br><span class="line">  -parameters                生成元数据以用于方法参数的反射</span><br><span class="line">  -d &lt;目录&gt;                    指定放置生成的类文件的位置</span><br><span class="line">  -s &lt;目录&gt;                    指定放置生成的源文件的位置</span><br><span class="line">  -h &lt;目录&gt;                    指定放置生成的本机标头文件的位置</span><br><span class="line">  -implicit:&#123;none,class&#125;     指定是否为隐式引用文件生成类文件</span><br><span class="line">  -encoding &lt;编码&gt;             指定源文件使用的字符编码</span><br><span class="line">  -<span class="built_in">source</span> &lt;发行版&gt;              提供与指定发行版的源兼容性</span><br><span class="line">  -target &lt;发行版&gt;              生成特定 VM 版本的类文件</span><br><span class="line">  -profile &lt;配置文件&gt;            请确保使用的 API 在指定的配置文件中可用</span><br><span class="line">  -version                   版本信息</span><br><span class="line">  -<span class="built_in">help</span>                      输出标准选项的提要</span><br><span class="line">  -A关键字[=值]                  传递给注释处理程序的选项</span><br><span class="line">  -X                         输出非标准选项的提要</span><br><span class="line">  -J&lt;标记&gt;                     直接将 &lt;标记&gt; 传递给运行时系统</span><br><span class="line">  -Werror                    出现警告时终止编译</span><br><span class="line">  @&lt;文件名&gt;                     从文件读取选项和文件名</span><br></pre></td></tr></table></figure>
<p>如果你得到了类似下面错误的输出，请务必重新检查上面的安装步骤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;javac&#x27;</span> 不是内部或外部命令，也不是可运行的程序</span><br><span class="line">或批处理文件。</span><br></pre></td></tr></table></figure>
<p>到此 JDK 的安装就算完成了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/8e5d9aba9ab845a9924c10565d53ecb7/" data-id="ckmcqox4300650kuvci319wj5" data-title="Windows 上安装 JDK 并设置环境变量" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-a639856713894b5cb3d9813cb1635ee6" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/a639856713894b5cb3d9813cb1635ee6/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/a639856713894b5cb3d9813cb1635ee6/">Java 微信公众号开发</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><a href="#java-%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7%E5%BC%80%E5%8F%91">Java 微信公众号开发</a><ul>
<li><a href="#%E5%9C%BA%E6%99%AF">场景</a></li>
<li><a href="#%E6%B3%A8%E5%86%8C%E5%BE%AE%E4%BF%A1%E5%85%AC%E4%BC%97%E5%8F%B7">注册微信公众号</a></li>
<li><a href="#%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE">基本配置</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8%E6%B5%8B%E8%AF%95%E8%B4%A6%E5%8F%B7">使用测试账号</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%BC%96%E7%A0%81">服务端编码</a><ul>
<li><a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%B9%E7%9B%AE">初始化项目</a></li>
<li><a href="#%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F">内网穿透</a></li>
<li><a href="#%E5%BE%AE%E4%BF%A1%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%A4%E8%AF%81">微信服务器认证</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86">消息处理</a></li>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%8F%9C%E5%8D%95">创建菜单</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>公司需要做一个微信的公众号，以前没有玩过结果踩了一堆坑，也是无奈了，便在这里记录一下</p>
<h2 id="注册微信公众号"><a href="#注册微信公众号" class="headerlink" title="注册微信公众号"></a>注册微信公众号</h2><p>首先在 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/">微信公众平台</a> 注册一个账号，这里选择了 _订阅号_，填写一堆乱七八糟的信息后就得到了一个微信公众号（订阅号）了。之后登录的话却是要进行扫码操作（反人类操作）。</p>
<h2 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h2><p>在【开发 &gt; 基本配置】中设定好相关的信息，主要有</p>
<ul>
<li>开发者 ID(AppID)：自动生成</li>
<li>开发者密码(AppSecret)：修改完之后记录下来，一会还要用到</li>
<li>IP 白名单：可以公网访问的服务器 IP 地址（没有也行，后面会说到 <strong>内网穿透</strong>）</li>
<li>服务器地址(URL)：用于给微信校验的服务器地址，没有公网服务器也行</li>
<li>令牌(Token)：自定义，随机字符串即可，可以在 <a target="_blank" rel="noopener" href="https://www.lastpass.com/zh/password-generator">LastPass</a> 生成一个</li>
<li>消息加解密密钥(EncodingAESKey)：点击随机生成即可</li>
<li>消息加解密方式：目前选择明文模式</li>
</ul>
<blockquote>
<p>配置服务器地址时会报错，先不管了就行，后面会再回来配置的。</p>
</blockquote>
<h2 id="使用测试账号"><a href="#使用测试账号" class="headerlink" title="使用测试账号"></a>使用测试账号</h2><p>有了自己的微信公众号当然很好，但不可能每次都直接修改真正的公众号吧，修改挂了怎么办？所以就有了测试公众号，而且测试公众号的权限是要高于普通的未认证订阅号的。</p>
<p>在【开发 &gt; 公众平台测试帐号 &gt; 公众平台测试帐号】中申请一个测试账号，如 <a href="#%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE">基本配置</a> 所述中配置一下。</p>
<blockquote>
<p>安全域名设置：如果你有的自己的域名和服务器的话就配置，否则就先不管。</p>
</blockquote>
<h2 id="服务端编码"><a href="#服务端编码" class="headerlink" title="服务端编码"></a>服务端编码</h2><h3 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h3><p>为了简化配置这里使用 SpringBoot Web 项目作为例子（注意勾上 web 模块依赖）</p>
<h3 id="内网穿透"><a href="#内网穿透" class="headerlink" title="内网穿透"></a>内网穿透</h3><p>使用内网穿透工具 serveo 实现将本地内网服务映射到外网的 80 端口上</p>
<blockquote>
<p>下面的命令要求系统已经安装了 SSH 客户端，Linux 已经默认安装了，如果是 Windows 可以使用 Cmder 或 Git For Windows 之类的。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -o ServerAliveInterval=60 -R rx:80:localhost:8080 serveo.net</span><br></pre></td></tr></table></figure>
<blockquote>
<p>具体可以参考 <a target="_blank" rel="noopener" href="https://serveo.net/">官网</a> 或 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/5ad7fa84/">使用 Serveo 进行内网穿透</a></p>
</blockquote>
<p>现在，访问 <a target="_blank" rel="noopener" href="https://rx.serveo.net/">https://rx.serveo.net/</a>，是不是已经可以啦（出现的 <code>Whitelabel Error Page</code> 不用管，因为我们本来也没有处理 <code>/</code> 路径的访问）</p>
<h3 id="微信服务器认证"><a href="#微信服务器认证" class="headerlink" title="微信服务器认证"></a>微信服务器认证</h3><p>引入额外的依赖（SpringBoot Web 项目默认引入 <code>spring-boot-starter</code>，<code>spring-boot-starter-web</code> 和 <code>spring-boot-starter-test</code> 模块）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--微信的公众号依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.binarywang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>weixin-java-mp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加配置文件 <code>application.yml</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 非必需，但这里还是设定一下端口，方便后面写启动脚本</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">custom:</span></span><br><span class="line">  <span class="attr">wx:</span></span><br><span class="line">    <span class="attr">mp:</span></span><br><span class="line">      <span class="comment"># 基本上都是微信公众号那边的设置（这里是测试的）</span></span><br><span class="line">      <span class="attr">appId:</span> <span class="string">appId</span></span><br><span class="line">      <span class="attr">secret:</span> <span class="string">secret</span></span><br><span class="line">      <span class="attr">token:</span> <span class="string">token</span></span><br><span class="line">      <span class="attr">aesKey:</span> <span class="string">aesKey</span></span><br></pre></td></tr></table></figure>
<p>将配置读取到 Java Bean 对象上方便在程序中使用 <code>WxMpPropertiesConfig</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信公众号属性配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;custom.wx.mp&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpPropertiesConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line">    <span class="keyword">private</span> String aesKey;</span><br><span class="line">    <span class="comment">// getter() and setter()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加微信相关的主配置类 <code>WxMpMainConfig</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信公众号主要的配置类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(WxMpPropertiesConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpMainConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WxMpPropertiesConfig wxMpPropertiesConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信公众号的服务对象</span></span><br><span class="line"><span class="comment">     * 用户调用微信的各种 API, 例如获取 access_token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> WxMpService wxMpService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WxMpMainConfig</span><span class="params">(WxMpPropertiesConfig wxMpPropertiesConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.wxMpPropertiesConfig = wxMpPropertiesConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化路由列表和微信服务 api 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//配置微信 api 对象的策略（目前在内存中）</span></span><br><span class="line">        <span class="keyword">final</span> WxMpInMemoryConfigStorage storage = <span class="keyword">new</span> WxMpInMemoryConfigStorage();</span><br><span class="line">        storage.setAppId(wxMpPropertiesConfig.getAppId());</span><br><span class="line">        storage.setSecret(wxMpPropertiesConfig.getSecret());</span><br><span class="line">        storage.setAesKey(wxMpPropertiesConfig.getAesKey());</span><br><span class="line">        storage.setToken(wxMpPropertiesConfig.getToken());</span><br><span class="line">        <span class="comment">//设置策略到服务对象中</span></span><br><span class="line">        wxMpService = <span class="keyword">new</span> WxMpServiceImpl();</span><br><span class="line">        wxMpService.setWxMpConfigStorage(storage);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpService <span class="title">wxMpService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wxMpService;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加一个窗口 api 用于给微信调用 <code>WxMpPortalApi</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信服务窗口 api</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/wx/portal&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpPortalApi</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WxMpService wxMpService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WxMpPortalApi</span><span class="params">(WxMpService wxMpService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.wxMpService = wxMpService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信认证当前服务可用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> signature 微信加密签名，signature 结合了开发者填写的 token 参数和请求中的 timestamp 参数、nonce 参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timestamp 时间戳</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nonce     随机数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> echostr   成功后回传的随机字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> echostr&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">authGet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            String signature,</span></span></span><br><span class="line"><span class="function"><span class="params">            String timestamp,</span></span></span><br><span class="line"><span class="function"><span class="params">            String nonce,</span></span></span><br><span class="line"><span class="function"><span class="params">            String echostr</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isAnyEmpty(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;请求非法参数!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (wxMpService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">            <span class="keyword">return</span> echostr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;非法请求&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启项目，将 <a target="_blank" rel="noopener" href="https://rx.serveo.net/wx/portal">https://rx.serveo.net/wx/portal</a> 填到服务器配置中的 url 里面，点击 <strong>提交</strong>，应该可以看到 [修改成功] 的提示了。</p>
<h3 id="消息处理"><a href="#消息处理" class="headerlink" title="消息处理"></a>消息处理</h3><p>很显然，如果我们只让微信认证我们的服务器的话是做不了什么的，所以我们需要监听并处理用户在微信公众号中的操作并返回结果。</p>
<p>修改微信服务窗口 api <code>WxMpPortalApi</code>，添加对 <code>post</code> 请求的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信服务窗口 api</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/wx/portal&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpPortalApi</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WxMpService wxMpService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WxMpMessageRouter router;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WxMpPortalApi</span><span class="params">(WxMpService wxMpService, WxMpMessageRouter router)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.wxMpService = wxMpService;</span><br><span class="line">        <span class="keyword">this</span>.router = router;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信认证当前服务可用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> signature 微信加密签名，signature 结合了开发者填写的 token 参数和请求中的 timestamp 参数、nonce 参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timestamp 时间戳</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nonce     随机数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> echostr   成功后回传的随机字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> echostr&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">authGet</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            String signature,</span></span></span><br><span class="line"><span class="function"><span class="params">            String timestamp,</span></span></span><br><span class="line"><span class="function"><span class="params">            String nonce,</span></span></span><br><span class="line"><span class="function"><span class="params">            String echostr</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isAnyEmpty(signature, timestamp, nonce, echostr)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;请求非法参数!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (wxMpService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">            <span class="keyword">return</span> echostr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;非法请求&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对所有来自微信服务器的消息进行预处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestBody 请求体（xml 格式）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 明文消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">authPost</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestBody</span> String requestBody,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(&quot;signature&quot;)</span> String signature,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(&quot;timestamp&quot;)</span> String timestamp,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(&quot;nonce&quot;)</span> String nonce,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(name = &quot;encrypt_type&quot;, required = false)</span> String encType,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(name = &quot;msg_signature&quot;, required = false)</span> String msgSignature</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> <span class="keyword">throws</span> JsonProcessingException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!wxMpService.checkSignature(timestamp, nonce, signature)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;非法请求, 并非微信发来的&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        WxMpXmlMessage inMessage = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (encType == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//明文传输</span></span><br><span class="line">            inMessage = WxMpXmlMessage.fromXml(requestBody);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;aes&quot;</span>.equals(encType)) &#123;</span><br><span class="line">            <span class="comment">//aes 加密</span></span><br><span class="line">            inMessage = WxMpXmlMessage.fromEncryptedXml(requestBody, wxMpService.getWxMpConfigStorage(), timestamp, nonce, msgSignature);</span><br><span class="line">        &#125;</span><br><span class="line">        WxMpXmlOutMessage outMessage = router.route(inMessage);</span><br><span class="line">        log.info(<span class="string">&quot;客户端发送的消息: &#123;&#125;&quot;</span>, <span class="keyword">new</span> ObjectMapper().writeValueAsString(outMessage));</span><br><span class="line">        <span class="keyword">return</span> outMessage == <span class="keyword">null</span> ? <span class="string">&quot;&quot;</span> : outMessage.toXml();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加一个用户消息处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基础微信消息处理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseHandler</span> <span class="keyword">implements</span> <span class="title">WxMpMessageHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认空实现</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> wxMessage      微信的消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context        上下文环境(用于在 handler 中传递信息)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> wxMpService    微信 api 服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sessionManager 会话管理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> xml 格式的消息, 异步可返回 null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title">handle</span><span class="params">(WxMpXmlMessage wxMessage, Map&lt;String, Object&gt; context, WxMpService wxMpService, WxSessionManager sessionManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户发送消息的处理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MsgHandler</span> <span class="keyword">extends</span> <span class="title">BaseHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpXmlOutMessage <span class="title">handle</span><span class="params">(WxMpXmlMessage wxMessage, Map&lt;String, Object&gt; context, WxMpService wxMpService, WxSessionManager sessionManager)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;接收到消息: &#123;&#125;&quot;</span>, wxMessage.getMsg());</span><br><span class="line">        <span class="keyword">final</span> String content = <span class="string">&quot;您发送的消息为: &quot;</span> + wxMessage.getContent();</span><br><span class="line">        <span class="keyword">return</span> WxMpXmlOutMessage.TEXT().content(content)</span><br><span class="line">                .fromUser(wxMessage.getToUser())</span><br><span class="line">                .toUser(wxMessage.getFromUser())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改微信公众号主要的配置类 <code>WxMpMainConfig</code>，添加路由管理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信公众号主要的配置类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(WxMpPropertiesConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpMainConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WxMpPropertiesConfig wxMpPropertiesConfig;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MsgHandler msgHandler;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信公众号监听管理路由映射表</span></span><br><span class="line"><span class="comment">     * 其实就是监听用户在公众号的操作罢了, 比如点击了某个菜单, 发送了一些消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> WxMpMessageRouter wxMpMessageRouter;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信公众号的服务对象</span></span><br><span class="line"><span class="comment">     * 用户调用微信的各种 API, 例如获取 access_token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> WxMpService wxMpService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WxMpMainConfig</span><span class="params">(WxMpPropertiesConfig wxMpPropertiesConfig, MsgHandler msgHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.wxMpPropertiesConfig = wxMpPropertiesConfig;</span><br><span class="line">        <span class="keyword">this</span>.msgHandler = msgHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化路由列表和微信服务 api 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//配置微信 api 对象的策略（目前在内存中）</span></span><br><span class="line">        <span class="keyword">final</span> WxMpInMemoryConfigStorage storage = <span class="keyword">new</span> WxMpInMemoryConfigStorage();</span><br><span class="line">        storage.setAppId(wxMpPropertiesConfig.getAppId());</span><br><span class="line">        storage.setSecret(wxMpPropertiesConfig.getSecret());</span><br><span class="line">        storage.setAesKey(wxMpPropertiesConfig.getAesKey());</span><br><span class="line">        storage.setToken(wxMpPropertiesConfig.getToken());</span><br><span class="line">        <span class="comment">//设置策略到服务对象中</span></span><br><span class="line">        wxMpService = <span class="keyword">new</span> WxMpServiceImpl();</span><br><span class="line">        wxMpService.setWxMpConfigStorage(storage);</span><br><span class="line">        <span class="comment">//添加路由</span></span><br><span class="line">        wxMpMessageRouter = <span class="keyword">this</span>.newRouter(wxMpService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据微信 api 服务对象创建一个微信监听路由</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> wxMpService 微信 api 服务</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 微信监听路由对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> WxMpMessageRouter <span class="title">newRouter</span><span class="params">(WxMpService wxMpService)</span> </span>&#123;</span><br><span class="line">        WxMpMessageRouter router = <span class="keyword">new</span> WxMpMessageRouter(wxMpService);</span><br><span class="line">        <span class="comment">//发送消息(默认)</span></span><br><span class="line">        router.rule().async(<span class="keyword">false</span>).handler(<span class="keyword">this</span>.msgHandler).end();</span><br><span class="line">        <span class="keyword">return</span> router;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpService <span class="title">wxMpService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wxMpService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WxMpMessageRouter <span class="title">wxMpMessageRouter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> wxMpMessageRouter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在向公众号发送消息，就可以得到回复了（简单的）。还有日志，菜单，关注，取消关注等处理器这里就不赘述了</p>
<h3 id="创建菜单"><a href="#创建菜单" class="headerlink" title="创建菜单"></a>创建菜单</h3><p>创建一个简单的公众号菜单 Api 对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微信公众号菜单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> rxliuli</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/wx/menu/&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxMpMenuApi</span> <span class="keyword">extends</span> <span class="title">WxMpBaseApi</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建一个默认的菜单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 菜单 id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;create&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createDefault</span><span class="params">()</span> <span class="keyword">throws</span> WxErrorException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WxMenu wxMenu = <span class="keyword">new</span> WxMenu();</span><br><span class="line">        <span class="keyword">final</span> WxMenuButton buttonLeft = <span class="keyword">new</span> WxMenuButton();</span><br><span class="line">        buttonLeft.setType(WxConsts.MenuButtonType.CLICK);</span><br><span class="line">        buttonLeft.setName(<span class="string">&quot;点击&quot;</span>);</span><br><span class="line">        buttonLeft.setKey(IdWorker.getIdStr());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> WxMenuButton buttonRight = <span class="keyword">new</span> WxMenuButton();</span><br><span class="line">        buttonRight.setType(WxConsts.MenuButtonType.VIEW);</span><br><span class="line">        buttonRight.setName(<span class="string">&quot;链接&quot;</span>);</span><br><span class="line">        buttonRight.setUrl(<span class="string">&quot;https://blog.rxliuli.com&quot;</span>);</span><br><span class="line">        buttonRight.setKey(IdWorker.getIdStr());</span><br><span class="line">        wxMenu.getButtons().add(buttonLeft);</span><br><span class="line">        wxMenu.getButtons().add(buttonRight);</span><br><span class="line">        <span class="keyword">return</span> wxMpService.getMenuService().menuCreate(wxMenu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问 <a target="_blank" rel="noopener" href="https://rx.serveo.net/wx/menu/create">https://rx.serveo.net/wx/menu/create</a> 就可以为微信公众号创建一个简单的菜单了。点击左边的“点击”按钮会回复文字说点击了什么，右边的链接则会跳转到一个网页。</p>
<blockquote>
<p>其他的功能就放到后面再实现吧，更多公众号开发相关的内容可以参考 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/wiki">微信官方文档</a> 和 <a target="_blank" rel="noopener" href="https://github.com/Wechat-Group/weixin-java-tools">微信开发工具包</a>。当然，所有的示例代码吾辈都已经放到了 <a target="_blank" rel="noopener" href="https://github.com/rxliuli/wx-mp-example">GitHub</a>，却是可以参考一下的呢</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/a639856713894b5cb3d9813cb1635ee6/" data-id="ckmcqox4b006x0kuv90po57pm" data-title="Java 微信公众号开发" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-aba4a6b2c531479980e3993b60f1bdfb" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/04/18/aba4a6b2c531479980e3993b60f1bdfb/" class="article-date">
  <time class="dt-published" datetime="2020-04-18T02:14:09.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/04/18/aba4a6b2c531479980e3993b60f1bdfb/">Windows 上 Maven 安装与使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p><a target="_blank" rel="noopener" href="https://maven.apache.org/">官网</a>, <a target="_blank" rel="noopener" href="https://github.com/apache/maven">GitHub</a></p>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Maven 已经是 Java 事实上的依赖管理标准工具了，所以学习使用 maven 有益无害。</p>
<h2 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h2><ul>
<li>[x] 必须已经安装了 JDK 并设置了环境变量，如果还没有安装，请参考 <a target="_blank" rel="noopener" href="https://blog.rxliuli.com/p/d0cf29fa/">Windows 上安装 JDK 并设置环境变量</a> 进行安装</li>
</ul>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>在官网 <a target="_blank" rel="noopener" href="https://maven.apache.org/download.cgi">下载页面</a> 找到 <strong>Binary zip archive</strong> 下载二进制数据。</p>
<p><img src="https://img.rxliuli.com/20181109124211.png" alt="Maven 下载页面"></p>
<blockquote>
<p>这里不使用二进制安装包的原因是绿色版更容易迁移，而且是跨平台的。</p>
</blockquote>
<h2 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h2><p>将文件夹解压到某个位置，然后在环境变量 <strong>Path</strong> 中添加 <em>/bin/</em> 目录</p>
<p><img src="https://img.rxliuli.com/20181109124557.png" alt="Maven 设置环境变量"></p>
<h2 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h2><p>使用 cmd 打开命令行，输入 <code>mvn --version</code>，你应该得到了类似于下面的输出</p>
<p><img src="https://img.rxliuli.com/20181109124924.png" alt="查看 Maven 的版本"></p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><ol>
<li><p>创建一个普通的项目</p>
<p> 直接使用命令行根据模板创建项目在实际中极为罕见，这里只是演示一下 maven 可以使用命令行创建项目而已</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn archetype:generate -DgroupId=com.rxliuli.maven.example -DartifactId=HelloWorld -DarchetypeArtifactId</span><br><span class="line">=maven-archetype-quickstart -DinteractiveMode=<span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p> 应该会得到如下输出</p>
<p> <img src="https://img.rxliuli.com/20181109130243.png" alt="Maven 使用命令行创建模板项目"></p>
</li>
<li><p>进入项目</p>
<p> 项目目录结构</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">HelloWorld</span><br><span class="line">└─src</span><br><span class="line">├─main</span><br><span class="line">│  └─java</span><br><span class="line">│      └─com</span><br><span class="line">│          └─rxliuli</span><br><span class="line">│              └─maven</span><br><span class="line">│                  └─example</span><br><span class="line">└─<span class="built_in">test</span></span><br><span class="line">    └─java</span><br><span class="line">        └─com</span><br><span class="line">            └─rxliuli</span><br><span class="line">                └─maven</span><br><span class="line">                    └─example</span><br></pre></td></tr></table></figure>
<p> maven 项目的配置文件是 <code>pom.xml</code>，而 <strong>源码</strong> 与 <strong>测试</strong> 代码则分离到了两个单独的文件夹</p>
</li>
<li><p>maven 基本命令</p>
<ul>
<li>package(mvn package): 打包项目</li>
<li>clean(mvn clean): 清理打包目录</li>
<li>test(mvn test): 执行 test 目录下的测试</li>
<li>install(mvn install): 打包项目并安装到本地</li>
</ul>
</li>
</ol>
<p>其实原生 maven 了解多少并没有什么，因为 IDE 基本都集成了这些开源的工具，并不需要我们手动输入 maven 命令了。嘛，多少了解一些也是挺好的啦ヽ(=^･ω･^=)丿</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/04/18/aba4a6b2c531479980e3993b60f1bdfb/" data-id="ckmcqox4e007a0kuv4jhg6gov" data-title="Windows 上 Maven 安装与使用" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/6/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/8/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/electron/" rel="tag">electron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grid/" rel="tag">grid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jetbrains/" rel="tag">jetbrains</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/" rel="tag">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typescript/" rel="tag">typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webstorm/" rel="tag">webstorm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AA%E4%BA%BA/" rel="tag">个人</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%AC%E5%8F%B8/" rel="tag">公司</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%91%A8%E6%8A%A5/" rel="tag">周报</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%A3%E5%91%8A/" rel="tag">宣告</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">工程化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90/" rel="tag">开源</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%82%E6%AD%A5/" rel="tag">异步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%85%E6%9B%B4%E6%96%B0/" rel="tag">待更新</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BB%8F%E9%AA%8C/" rel="tag">经验</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6/" rel="tag">读书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/css/" style="font-size: 12.14px;">css</a> <a href="/tags/electron/" style="font-size: 15.71px;">electron</a> <a href="/tags/git/" style="font-size: 12.86px;">git</a> <a href="/tags/grid/" style="font-size: 10.71px;">grid</a> <a href="/tags/java/" style="font-size: 19.29px;">java</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/jetbrains/" style="font-size: 12.14px;">jetbrains</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/markdown/" style="font-size: 10.71px;">markdown</a> <a href="/tags/react/" style="font-size: 14.29px;">react</a> <a href="/tags/sql/" style="font-size: 14.29px;">sql</a> <a href="/tags/typescript/" style="font-size: 12.14px;">typescript</a> <a href="/tags/vscode/" style="font-size: 12.86px;">vscode</a> <a href="/tags/vue/" style="font-size: 16.43px;">vue</a> <a href="/tags/webstorm/" style="font-size: 10px;">webstorm</a> <a href="/tags/windows/" style="font-size: 17.14px;">windows</a> <a href="/tags/%E4%B8%AA%E4%BA%BA/" style="font-size: 12.86px;">个人</a> <a href="/tags/%E5%85%AC%E5%8F%B8/" style="font-size: 10px;">公司</a> <a href="/tags/%E5%91%A8%E6%8A%A5/" style="font-size: 10px;">周报</a> <a href="/tags/%E5%AE%A3%E5%91%8A/" style="font-size: 10px;">宣告</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 13.57px;">工具</a> <a href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="font-size: 17.86px;">工程化</a> <a href="/tags/%E5%BC%80%E6%BA%90/" style="font-size: 10px;">开源</a> <a href="/tags/%E5%BC%82%E6%AD%A5/" style="font-size: 15px;">异步</a> <a href="/tags/%E5%BE%85%E6%9B%B4%E6%96%B0/" style="font-size: 10.71px;">待更新</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 18.57px;">杂谈</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BB%8F%E9%AA%8C/" style="font-size: 11.43px;">经验</a> <a href="/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 12.14px;">读书</a> <a href="/tags/%E8%BD%AC%E8%BD%BD/" style="font-size: 11.43px;">转载</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/14/8fb2d58463ae4191ac064a76e15bffbd/">2021 第十周</a>
          </li>
        
          <li>
            <a href="/2021/03/12/7e7131c07c984d928ba3fefa7a9cef06/">读书-[颓废与沉默：透视犬儒文化]</a>
          </li>
        
          <li>
            <a href="/2021/03/02/db74e6e5d2444bc3b6e185a7b338bbf6/">electron 开发经验之谈系列-在渲染、主进程间共享数据</a>
          </li>
        
          <li>
            <a href="/2021/02/27/06cb464179cf45c598208534705aae3c/">2020 吾辈在公司推动的前端技术演进</a>
          </li>
        
          <li>
            <a href="/2021/02/23/cd66150d2b86448590fcc9bb2419c0b2/">实践 lerna monorepo</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>