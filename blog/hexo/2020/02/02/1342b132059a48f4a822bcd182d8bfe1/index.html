<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>浅谈 Vue SPA 网站 URL 保存数据实践 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="场景 该功能吾辈已经封装成 NPM 库 vue-url-persist  在使用 Vue SPA 开发面向普通用户的网站时，吾辈也遇到了一些之前未被重视，但却实实在在存在的问题，这次便浅谈一下 SPA 网站将所有数据都存储到内存中导致数据很容易丢失以及吾辈思考并尝试的解决方案。  参考：SPA 全称 single page application，意为 单页应用，不是泥萌想的那样！#笑哭  思维导">
<meta property="og:type" content="article">
<meta property="og:title" content="浅谈 Vue SPA 网站 URL 保存数据实践">
<meta property="og:url" content="http://example.com/2020/02/02/1342b132059a48f4a822bcd182d8bfe1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="场景 该功能吾辈已经封装成 NPM 库 vue-url-persist  在使用 Vue SPA 开发面向普通用户的网站时，吾辈也遇到了一些之前未被重视，但却实实在在存在的问题，这次便浅谈一下 SPA 网站将所有数据都存储到内存中导致数据很容易丢失以及吾辈思考并尝试的解决方案。  参考：SPA 全称 single page application，意为 单页应用，不是泥萌想的那样！#笑哭  思维导">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/rxliuli/img-bed/20200105012847.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/rxliuli/img-bed/20200105012848.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/rxliuli/img-bed/20200105012846.png">
<meta property="article:published_time" content="2020-02-02T02:15:37.000Z">
<meta property="article:modified_time" content="2020-12-24T23:17:44.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="工程化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/rxliuli/img-bed/20200105012847.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-1342b132059a48f4a822bcd182d8bfe1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/02/1342b132059a48f4a822bcd182d8bfe1/" class="article-date">
  <time class="dt-published" datetime="2020-02-02T02:15:37.000Z" itemprop="datePublished">2020-02-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      浅谈 Vue SPA 网站 URL 保存数据实践
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><blockquote>
<p>该功能吾辈已经封装成 NPM 库 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vue-url-persist">vue-url-persist</a></p>
</blockquote>
<p>在使用 Vue SPA 开发面向普通用户的网站时，吾辈也遇到了一些之前未被重视，但却实实在在存在的问题，这次便浅谈一下 SPA 网站将所有数据都存储到内存中导致数据很容易丢失以及吾辈思考并尝试的解决方案。</p>
<blockquote>
<p>参考：SPA 全称 <code>single page application</code>，意为 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%8D%95%E9%A1%B5%E5%BA%94%E7%94%A8">单页应用</a>，不是泥萌想的那样！#笑哭</p>
</blockquote>
<p>思维导图</p>
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:525px; height:245px;" src="https://www.processon.com/embed/5e1e5d93e4b0c3908f881d64"></iframe>

<p>首先列出为什么遇到这个问题，具体场景及解决的问题是什么？</p>
<p>想要解决的一些问题</p>
<ol>
<li> 刷新页面数据不丢失：因为数据都保存在内存中，所以刷新之后自然不存在了</li>
<li> URL 复制给其他人数据不丢失：因为数据没有持久化到 URL 上，也没有根据 URL 上的数据进行初始化，所以复制给别人的 URL 当然会丢失数据（搜索条件之类）</li>
<li> 页面返回数据不丢失：因为数据都保存在内存中，所以跳转到其他路由再跳转回来数据当然不会存在了</li>
</ol>
<p>那么，先谈一下每个问题的解决方案</p>
<ol>
<li>刷新页面数据不丢失<ul>
<li>将数据序列化到本地，例如 <code>localStorage</code> 中，然后在刷新后获取一次<ul>
<li>注：这方面已经有先行者了，例如 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vuex-persist">vuex-persist</a> 和 <a target="_blank" rel="noopener" href="https://github.com/robinvdvleuten/vuex-persistedstate">vuex-persistedstate</a></li>
</ul>
</li>
<li>将数据序列化到 URL 上，每次加载都从 URL 上获取数据</li>
</ul>
</li>
<li>URL 复制给其他人数据不丢失<ul>
<li>只能将数据序列化到 URL 上</li>
</ul>
</li>
<li>页面返回数据不丢失<ul>
<li>将数据放到 vuex 中，并且在 URL 上使用 <code>key</code> 进行标识<ul>
<li>注：这方面已经有先行者了，例如 <a target="_blank" rel="noopener" href="https://www.npmjs.com/package/vue-navigation">vue-navigation</a> 和 <a target="_blank" rel="noopener" href="https://github.com/vuejs/vuex-router-sync">vuex-router-sync</a></li>
</ul>
</li>
<li>将数据序列化到 URL 上，并且不新增路由记录</li>
<li>使用 vue-router 的缓存 <code>keep-alive</code></li>
</ul>
</li>
</ol>
<p>在了解了这么多的解决方案之后，吾辈最终选择了兼容性最好的 URL 保存数据，它能同时解决 3 个问题。然而，很遗憾的是，这似乎并没有很多人讨论这个问题，或许，这个问题本应该是默认就需要解决的，亦或是 SPA 网站真的很少关心这些了。</p>
<blockquote>
<p>虽说如此，吾辈还是找到了一些讨论的 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/42226479">StackOverflow: How to hold URL query params in Vue with Vue-Router</a></p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>一个基本的思路是能够确定的</p>
<ol>
<li> 在组件创建时，从 URL 获取数据并为需要的数据进行初始化</li>
<li> 在这些数据变化时，及时将数据序列化到 URL 上</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/rxliuli/img-bed/20200105012847.png" alt="思路图"></p>
<p>然后，再次出现了一个分歧点，到底要不要绑定 Vue？</p>
<ol>
<li>不绑定 vue 手动监听对象变化并将对象的变化响应到 URL 上<br> <img src="https://cdn.jsdelivr.net/gh/rxliuli/img-bed/20200105012848.png" alt="不绑定 vue"></li>
<li>绑定 vue 并使用它的生命周期 <code>created, beforeRouteUpdate</code> 与监听器 <code>watch</code><br> <img src="https://cdn.jsdelivr.net/gh/rxliuli/img-bed/20200105012846.png" alt="绑定 vue"></li>
</ol>
<p>那么，两者有什么区别呢？</p>
<table>
<thead>
<tr>
<th>思路</th>
<th>不绑定 vue</th>
<th>绑定 vue</th>
</tr>
</thead>
<tbody><tr>
<td>优点</td>
<td>非框架强相关，理论上可以通用 <code>Vue/React</code></td>
<td>不需要手动实现 URL 的几种序列化模式，可以预见至少有两种：<code>HTML 5 History/Hash</code></td>
</tr>
<tr>
<td></td>
<td>没有 vue/vue-router 的历史包袱</td>
<td>不需要手动实现数据监听/响应（虽然现在已然不算难了）</td>
</tr>
<tr>
<td></td>
<td>可以不管 vue-router 实现 URL 动态设置，可以自动优雅降级</td>
<td>灵活性很强，实现比较好的封装之后使用成本很低</td>
</tr>
<tr>
<td>缺点</td>
<td>没有包袱，但同时没有基础，序列化/数据监听都需要手动实现</td>
<td>存在历史包袱，vue/vue-router 的怪癖一点都绕不过去</td>
</tr>
<tr>
<td></td>
<td>灵活性不足，只能初始化一次，需要/不需要序列化的数据分割也相当有挑战</td>
<td>依赖 vue/vue-router，在其更新之时也必须跟着更新</td>
</tr>
<tr>
<td></td>
<td>不绑定 vue 意味着与 vue 不可能完美契合</td>
<td>无法通用，在任何一个其他框架（React）上还要再写一套</td>
</tr>
</tbody></table>
<p>最终，在这个十字路口反复踌躇之后，吾辈选择了更加灵活、成本更低的第二种解决方案。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="已解决"><a href="#已解决" class="headerlink" title="已解决"></a>已解决</h3><ul>
<li>序列化数据到 URL 上导致路由记录会随着改变增加</li>
<li>即时序列化数据到 URL 上不现实<blockquote>
<p>这里吾辈对 <a target="_blank" rel="noopener" href="https://yarnpkg.com/">yarn</a> 进行了考察发现其也是异步更新 URL</p>
</blockquote>
</li>
<li>序列化到 URL 上时导致的死循环，<code>序列化数据到 URL 上 =&gt; 路由更新触发 =&gt; 初始化数据到 URL 上 =&gt; 触发数据改变 =&gt; 序列化数据到 URL 上。。。</code></li>
<li>同一个路由携带不同的查询参数的 URL 直接在地址栏输入回车一次不会触发页面数据更新</li>
<li>URL 最大保存数据 IE 最多支持 <code>2083</code> 长度的 URL，换算为中文即为 <code>231</code> 个，所以不能作为一种通用方式进行</li>
<li>Vue 插件不能动态混入，而是在各个生命周期中判断是否要处理的</li>
</ul>
<h3 id="仍遗留"><a href="#仍遗留" class="headerlink" title="仍遗留"></a>仍遗留</h3><ul>
<li>JSON 序列化的数据长度较 query param 更大</li>
</ul>
<blockquote>
<p>下面是具体实现及代码，不喜欢的话可以直接跳到最下面的 <a href="#%E6%80%BB%E7%BB%93">总结</a>。</p>
</blockquote>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/rxliuli/example/tree/linter_vue_example/vue_url_persist_vue_example">GitHub</a></p>
</blockquote>
<h3 id="基本尝试"><a href="#基本尝试" class="headerlink" title="基本尝试"></a>基本尝试</h3><p>首先，尝试不使用任何封装，直接在 <code>created</code> 生命周期中初始化并绑定 <code>$watch</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;form1&quot;</span>&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;label <span class="keyword">for</span>=<span class="string">&quot;keyword&quot;</span>&gt;搜索名:&lt;/label&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;text&quot;</span> v-model=<span class="string">&quot;form.keyword&quot;</span> id=<span class="string">&quot;keyword&quot;</span> /&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;input</span><br><span class="line">        type=<span class="string">&quot;checkbox&quot;</span></span><br><span class="line">        v-model=<span class="string">&quot;form.hobbyList&quot;</span></span><br><span class="line">        id=<span class="string">&quot;anime&quot;</span></span><br><span class="line">        value=<span class="string">&quot;anime&quot;</span></span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;label <span class="keyword">for</span>=<span class="string">&quot;anime&quot;</span>&gt;动画&lt;/label&gt;</span><br><span class="line">      &lt;input type=<span class="string">&quot;checkbox&quot;</span> v-model=<span class="string">&quot;form.hobbyList&quot;</span> id=<span class="string">&quot;game&quot;</span> value=<span class="string">&quot;game&quot;</span> /&gt;</span><br><span class="line">      &lt;label <span class="keyword">for</span>=<span class="string">&quot;game&quot;</span>&gt;游戏&lt;/label&gt;</span><br><span class="line">      &lt;input</span><br><span class="line">        type=<span class="string">&quot;checkbox&quot;</span></span><br><span class="line">        v-model=<span class="string">&quot;form.hobbyList&quot;</span></span><br><span class="line">        id=<span class="string">&quot;movie&quot;</span></span><br><span class="line">        value=<span class="string">&quot;movie&quot;</span></span><br><span class="line">      /&gt;</span><br><span class="line">      &lt;label <span class="keyword">for</span>=<span class="string">&quot;movie&quot;</span>&gt;电影&lt;/label&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;p&gt;</span><br><span class="line">      &#123;&#123; form &#125;&#125;</span><br><span class="line">    &lt;/p&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">&#x27;Form1&#x27;</span>,</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      form: &#123;</span><br><span class="line">        keyword: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        hobbyList: [],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="string">&#x27;qb&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(<span class="built_in">this</span>.$route.query[key] || <span class="string">&#x27;&#123;&#125;&#x27;</span>)</span><br><span class="line">    <span class="built_in">Object</span>.assign(<span class="built_in">this</span>.form, urlData.form)</span><br><span class="line">    <span class="built_in">this</span>.$watch(</span><br><span class="line">      <span class="string">&#x27;form&#x27;</span>,</span><br><span class="line">      <span class="function"><span class="keyword">function</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">        urlData.form = val</span><br><span class="line">        <span class="built_in">this</span>.$router.replace(&#123;</span><br><span class="line">          query: &#123;</span><br><span class="line">            ...this.$route.query,</span><br><span class="line">            [key]: <span class="built_in">JSON</span>.stringify(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        deep: <span class="literal">true</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    )</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="分离通用性函数"><a href="#分离通用性函数" class="headerlink" title="分离通用性函数"></a>分离通用性函数</h3><p>然后，便是将之分离为单独的函数，方便在所有组件中进行复用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initUrlData</span>(<span class="params">exps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">&quot;qb&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(<span class="built_in">this</span>.$route.query[key] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">  exps.forEach(<span class="function">(<span class="params">exp</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.assign(<span class="built_in">this</span>[exp], urlData[exp]);</span><br><span class="line">    <span class="built_in">this</span>.$watch(</span><br><span class="line">      exp,</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">        urlData[exp] = val;</span><br><span class="line">        <span class="built_in">this</span>.$router.replace(&#123;</span><br><span class="line">          query: &#123;</span><br><span class="line">            ...this.$route.query,</span><br><span class="line">            [key]: <span class="built_in">JSON</span>.stringify(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        deep: <span class="literal">true</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用起来需要在 <code>created</code> 生命中调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    initUrlData.call(<span class="built_in">this</span>, [<span class="string">&quot;form&quot;</span>]);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="处理深层监听"><a href="#处理深层监听" class="headerlink" title="处理深层监听"></a>处理深层监听</h3><p>如果需要监听的值不是 data 下的顶级字段，而是深层字段的话，便不能直接使用 <code>[]</code> 进行取值和赋值了，而是需要实现支持深层取值/赋值的 <code>get/set</code>。而且，深层监听也意味着一般不会是对象，所以也不能采用 <code>Object.assign</code> 进行合并。</p>
<p>例如需要监听 <code>page</code> 对象中的 <code>offset, size</code> 两字段</p>
<p>首先，需要编写通用的 <code>get/set</code> 函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析字段字符串为数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>str 字段字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns </span>字符串数组，数组的 `[]` 取法会被解析为数组的一个元素</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseFieldStr</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> str</span><br><span class="line">    .split(<span class="regexp">/[\\.\\[]/</span>)</span><br><span class="line">    .map(<span class="function">(<span class="params">k</span>) =&gt;</span> (<span class="regexp">/\]$/</span>.test(k) ? k.slice(<span class="number">0</span>, k.length - <span class="number">1</span>) : k));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全的深度获取对象的字段</span></span><br><span class="line"><span class="comment"> * 注: 只要获取字段的值为 &#123;<span class="doctag">@type </span>null|undefined&#125;，就会直接返回 &#123;<span class="doctag">@param </span>defVal&#125;</span></span><br><span class="line"><span class="comment"> * 类似于 ES2019 的可选调用链特性: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/%E5%8F%AF%E9%80%89%E9%93%BE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>obj 获取的对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>fields 字段字符串或数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>[defVal] 取不到值时的默认值，默认为 null</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">obj, fields, defVal = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fields === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    fields = parseFieldStr(fields);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> res = obj;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> field <span class="keyword">of</span> fields) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      res = <span class="built_in">Reflect</span>.get(res, field);</span><br><span class="line">      <span class="keyword">if</span> (res === <span class="literal">undefined</span> || res === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> defVal;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">return</span> defVal;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全的深度设置对象的字段</span></span><br><span class="line"><span class="comment"> * 注: 只要设置字段的值为 &#123;<span class="doctag">@type </span>null|undefined&#125;，就会直接返回 &#123;<span class="doctag">@param </span>defVal&#125;</span></span><br><span class="line"><span class="comment"> * 类似于 ES2019 的可选调用链特性: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/%E5%8F%AF%E9%80%89%E9%93%BE</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>obj 设置的对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>fields 字段字符串或数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>[val] 设置字段的值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">obj, fields, val</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> fields === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    fields = parseFieldStr(fields);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> res = obj;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = fields.length; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> field = fields[i];</span><br><span class="line">    <span class="built_in">console</span>.log(i, res, field, res[field]);</span><br><span class="line">    <span class="keyword">if</span> (i === len - <span class="number">1</span>) &#123;</span><br><span class="line">      res[field] = val;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res = res[field];</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;res: &quot;</span>, res);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> res !== <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，是替换赋值操作，将之修改为一个专门的函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为 vue 实例上的字段进行深度赋值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setInitData</span>(<span class="params">vm, exp, urlData</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> oldVal = get(vm, exp, <span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> newVal = urlData[exp];</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> oldVal === <span class="string">&quot;object&quot;</span> &amp;&amp; newVal !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="built_in">Object</span>.assign(get(vm, exp), newVal);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    set(vm, exp, newVal);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initUrlData</span>(<span class="params">exps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">&quot;qb&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(<span class="built_in">this</span>.$route.query[key] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">  exps.forEach(<span class="function">(<span class="params">exp</span>) =&gt;</span> &#123;</span><br><span class="line">    setInitData(<span class="built_in">this</span>, exp, urlData);</span><br><span class="line">    <span class="built_in">this</span>.$watch(</span><br><span class="line">      exp,</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">        urlData[exp] = val;</span><br><span class="line">        <span class="built_in">this</span>.$router.replace(&#123;</span><br><span class="line">          query: &#123;</span><br><span class="line">            ...this.$route.query,</span><br><span class="line">            [key]: <span class="built_in">JSON</span>.stringify(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        deep: <span class="literal">true</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，便能单独监听对象中的某个字段了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initUrlData.call(<span class="built_in">this</span>, [<span class="string">&quot;form.keyword&quot;</span>]);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考：lodash 的函数 <a target="_blank" rel="noopener" href="https://lodash.com/docs/4.17.15#get">get</a>/<a target="_blank" rel="noopener" href="https://lodash.com/docs/4.17.15#set">set</a></p>
</blockquote>
<h3 id="使用防抖避免触发过快"><a href="#使用防抖避免触发过快" class="headerlink" title="使用防抖避免触发过快"></a>使用防抖避免触发过快</h3><p>但目前而言每次同步都是即时的，在数据量较大时，可能会存在一些问题，所以使用防抖避免每次数据更新都即时同步到 URL 上。</p>
<p>首先，实现一个简单的防抖函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 函数去抖</span></span><br><span class="line"><span class="comment"> * 去抖 (debounce) 去抖就是对于一定时间段的连续的函数调用，只让其执行一次</span></span><br><span class="line"><span class="comment"> * 注: 包装后的函数如果两次操作间隔小于 delay 则不会被执行, 如果一直在操作就会一直不执行, 直到操作停止的时间大于 delay 最小间隔时间才会执行一次, 不管任何时间调用都需要停止操作等待最小延迟时间</span></span><br><span class="line"><span class="comment"> * 应用场景主要在那些连续的操作, 例如页面滚动监听, 包装后的函数只会执行最后一次</span></span><br><span class="line"><span class="comment"> * 注: 该函数第一次调用一定不会执行，第一次一定拿不到缓存值，后面的连续调用都会拿到上一次的缓存值。如果需要在第一次调用获取到的缓存值，则需要传入第三个参数 &#123;<span class="doctag">@param </span>init&#125;，默认为 &#123;<span class="doctag">@code </span>undefined&#125; 的可选参数</span></span><br><span class="line"><span class="comment"> * 注: 返回函数结果的高阶函数需要使用 &#123;<span class="doctag">@see </span>Proxy&#125; 实现，以避免原函数原型链上的信息丢失</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>action 真正需要执行的操作</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>delay 最小延迟时间，单位为 ms</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>init 初始的缓存值，不填默认为 &#123;<span class="doctag">@see </span>undefined&#125;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return </span>function(...[*]=): Promise&lt;any&gt; &#123;<span class="doctag">@see </span>action&#125; 是否异步没有太大关联</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">debounce</span>(<span class="params">action, delay, init = <span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> flag;</span><br><span class="line">  <span class="keyword">let</span> result = init;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (flag) <span class="built_in">clearTimeout</span>(flag);</span><br><span class="line">      flag = <span class="built_in">setTimeout</span>(</span><br><span class="line">        () =&gt; resolve((result = action.apply(<span class="built_in">this</span>, args))),</span><br><span class="line">        delay</span><br><span class="line">      );</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> resolve(result), delay);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将 <code>$watch</code> 中的函数用 <code>debounce</code> 进行包装</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initUrlData</span>(<span class="params">exps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> key = <span class="string">&quot;qb&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(<span class="built_in">this</span>.$route.query[key] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">  exps.forEach(<span class="function">(<span class="params">exp</span>) =&gt;</span> &#123;</span><br><span class="line">    setInitData(<span class="built_in">this</span>, exp, urlData);</span><br><span class="line">    <span class="built_in">this</span>.$watch(</span><br><span class="line">      exp,</span><br><span class="line">      debounce(<span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">        urlData[exp] = val;</span><br><span class="line">        <span class="built_in">this</span>.$router.replace(&#123;</span><br><span class="line">          query: &#123;</span><br><span class="line">            ...this.$route.query,</span><br><span class="line">            [key]: <span class="built_in">JSON</span>.stringify(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;, <span class="number">1000</span>),</span><br><span class="line">      &#123;</span><br><span class="line">        deep: <span class="literal">true</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>引用：<a target="_blank" rel="noopener" href="https://juejin.im/post/5b8de829f265da43623c4261">掘金：7 分钟理解 JS 的节流、防抖及使用场景</a><br>参考：lodash 的函数 <a target="_blank" rel="noopener" href="https://lodash.com/docs/4.17.15#debounce">debounce</a></p>
</blockquote>
<h3 id="处理路由不变但-query-修改的问题"><a href="#处理路由不变但-query-修改的问题" class="headerlink" title="处理路由不变但 query 修改的问题"></a>处理路由不变但 query 修改的问题</h3><p>接下来，就需要处理一种小众，但确实存在的场景了。</p>
<ul>
<li>同一个组件被多个路由复用，这些路由仅仅只是一个 path param 改变了。例如 <a target="_blank" rel="noopener" href="https://ant.design/components/tabs-cn/">标签页</a></li>
<li>用户复制 URL 之后，发现其中的查询关键字错了，于是修改了关键字之后又复制了一次，而粘贴两次路由相同 query param 不同的 URL 是不会重新创建组件的</li>
</ul>
<p>首先确定基本的思路：在路由改变但组件没有重新创建时将 URL 上的数据为需要的数据进行初始化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在组件被 vue-router 路由复用时，单独进行初始化数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>route 将要改变的路由对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initUrlDataByRouteUpdate</span>(<span class="params">exps, route</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(route.query[key] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">  exps.forEach(<span class="function">(<span class="params">exp</span>) =&gt;</span> &#123;</span><br><span class="line">    setInitData(<span class="built_in">this</span>, exp, urlData);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 vue 实例的生命周期 <code>beforeRouteUpdate, beforeRouteEnter</code> 重新初始化 <code>data</code> 中的数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="function"><span class="title">beforeRouteUpdate</span>(<span class="params">to, <span class="keyword">from</span>, next</span>)</span> &#123;</span><br><span class="line">    initUrlDataByRouteUpdate.call(<span class="built_in">this</span>, [<span class="string">&quot;form&quot;</span>], to);</span><br><span class="line">    next();</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">beforeRouteEnter</span>(<span class="params">to, <span class="keyword">from</span>, next</span>)</span> &#123;</span><br><span class="line">    next(<span class="function">(<span class="params">vm</span>) =&gt;</span> initUrlDataByRouteUpdate.call(vm, [<span class="string">&quot;form&quot;</span>], to));</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>真的以为问题都解决了么？并不然，打开控制台你会发现一些 vue router 的警告</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vue-router.esm.js?8c4f:2051 Uncaught (<span class="keyword">in</span> promise) NavigationDuplicated &#123;_name: <span class="string">&quot;NavigationDuplicated&quot;</span>, name: <span class="string">&quot;NavigationDuplicated&quot;</span>, message: <span class="string">&quot;Navigating to current location (&quot;</span>/form1/?qb=%7B%22…,%22movie%22,%22game%22%5D%7D%7D<span class="string">&quot;) is not allowed&quot;</span>, stack: <span class="string">&quot;Error↵    at new NavigationDuplicated (webpack-int…/views/Form1.vue?vue&amp;type=script&amp;lang=js&amp;:222:40)&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>其实是因为循环触发导致的：<code>序列化数据到 URL 上 =&gt; 路由更新触发 =&gt; 初始化数据到 URL 上 =&gt; 触发数据改变 =&gt; 序列化数据到 URL 上。。。</code>，目前可行的解决方案是在 <code>$watch</code> 中判断数据是否与原来的相同，相同就不进行赋值，避免再次触发 vue-router 的 <code>beforeRouteUpdate</code> 生命周期。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initUrlData</span>(<span class="params">exps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(<span class="built_in">this</span>.$route.query[key] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">  exps.forEach(<span class="function">(<span class="params">exp</span>) =&gt;</span> &#123;</span><br><span class="line">    setInitData(<span class="built_in">this</span>, exp, urlData);</span><br><span class="line">    <span class="built_in">this</span>.$watch(</span><br><span class="line">      exp,</span><br><span class="line">      debounce(<span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">        urlData[exp] = val;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.$route.query[key] === <span class="built_in">JSON</span>.stringify(urlData)) &#123;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.$router.replace(&#123;</span><br><span class="line">          query: &#123;</span><br><span class="line">            ...this.$route.query,</span><br><span class="line">            [key]: <span class="built_in">JSON</span>.stringify(urlData),</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;, <span class="number">1000</span>),</span><br><span class="line">      &#123;</span><br><span class="line">        deep: <span class="literal">true</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在，控制台不会再有警告了。</p>
<h3 id="封装起来"><a href="#封装起来" class="headerlink" title="封装起来"></a>封装起来</h3><h4 id="使用-Vue-插件"><a href="#使用-Vue-插件" class="headerlink" title="使用 Vue 插件"></a>使用 Vue 插件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; debounce, get, set &#125; <span class="keyword">from</span> <span class="string">&quot;./common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueUrlPersist</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 一些选项</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.expListName = <span class="string">&quot;exps&quot;</span>;</span><br><span class="line">    <span class="built_in">this</span>.urlPersistName = <span class="string">&quot;qb&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将 URL 上的数据初始化到 data 上</span></span><br><span class="line"><span class="comment">   * 此处存在一个谬误</span></span><br><span class="line"><span class="comment">   * 1. 如果对象不使用合并而是赋值，则处理 [干净] 的 URL 就会很棘手，因为无法感知到初始值是什么</span></span><br><span class="line"><span class="comment">   * 2. 如果对象使用合并，则手动输入的相同路由不同参数的 URL 就无法处理</span></span><br><span class="line"><span class="comment">   *    注：该问题已经通过在 watch 中判断值是否变化而解决，但总感觉还有莫名其妙的坑在前面等着。。。</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">vm</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">expOrFn</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">urlData</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">initVueData</span>(<span class="params">vm, expOrFn, urlData</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = get(vm, expOrFn, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">const</span> newVal = urlData[expOrFn];</span><br><span class="line">    <span class="keyword">if</span> (oldVal === <span class="literal">undefined</span> || oldVal === <span class="literal">null</span>) &#123;</span><br><span class="line">      set(vm, expOrFn, newVal);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> oldVal === <span class="string">&quot;object&quot;</span> &amp;&amp; newVal !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.assign(get(vm, expOrFn), newVal);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在组件被 vue-router 路由复用时，单独进行初始化数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">vm</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">expOrFnList</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">route</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">initNextUrlData</span>(<span class="params">vm, expOrFnList, route</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(route.query[<span class="built_in">this</span>.urlPersistName] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;urlData: &quot;</span>, urlData);</span><br><span class="line">    expOrFnList.forEach(<span class="function">(<span class="params">expOrFn</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.initVueData(vm, expOrFn, urlData);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在组件被 vue 创建后初始化数据并监听之，在发生变化时自动序列化到 URL 上</span></span><br><span class="line"><span class="comment">   * 注：需要序列化到 URL 上的数据必须能被 JSON.stringfy 序列化</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">vm</span></span></span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param <span class="variable">expOrFnList</span></span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">initUrlData</span>(<span class="params">vm, expOrFnList</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(vm.$route.query[<span class="built_in">this</span>.urlPersistName] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">    expOrFnList.forEach(<span class="function">(<span class="params">expOrFn</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.initVueData(vm, expOrFn, urlData);</span><br><span class="line"></span><br><span class="line">      vm.$watch(</span><br><span class="line">        expOrFn,</span><br><span class="line">        debounce(<span class="number">1000</span>, <span class="keyword">async</span> (val) =&gt; &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">&quot;val 变化了: &quot;</span>, val);</span><br><span class="line">          urlData[expOrFn] = val;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            vm.$route.query[<span class="built_in">this</span>.urlPersistName] === <span class="built_in">JSON</span>.stringify(urlData)</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">await</span> vm.$router.replace(&#123;</span><br><span class="line">            query: &#123;</span><br><span class="line">              ...vm.$route.query,</span><br><span class="line">              [<span class="built_in">this</span>.urlPersistName]: <span class="built_in">JSON</span>.stringify(urlData),</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;),</span><br><span class="line">        &#123;</span><br><span class="line">          deep: <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">install</span>(<span class="params">Vue, options = &#123;&#125;</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (options.expListName) &#123;</span><br><span class="line">      <span class="built_in">this</span>.expListName = options.expListName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (options.urlPersistName) &#123;</span><br><span class="line">      <span class="built_in">this</span>.urlPersistName = options.urlPersistName;</span><br><span class="line">    &#125;</span><br><span class="line">    Vue.prototype.$urlPersist = <span class="built_in">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">initDataByRouteUpdate</span>(<span class="params">to</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> expList = <span class="built_in">this</span>[_this.expListName];</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(expList)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.$urlPersist.initNextUrlData(<span class="built_in">this</span>, expList, to);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Vue.mixin(&#123;</span><br><span class="line">      <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> expList = <span class="built_in">this</span>[_this.expListName];</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(expList)) &#123;</span><br><span class="line">          <span class="built_in">this</span>.$urlPersist.initUrlData(<span class="built_in">this</span>, expList);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">beforeRouteUpdate</span>(<span class="params">to, <span class="keyword">from</span>, next</span>)</span> &#123;</span><br><span class="line">        initDataByRouteUpdate.call(<span class="built_in">this</span>, to);</span><br><span class="line">        next();</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">beforeRouteEnter</span>(<span class="params">to, <span class="keyword">from</span>, next</span>)</span> &#123;</span><br><span class="line">        next(<span class="function">(<span class="params">vm</span>) =&gt;</span> initDataByRouteUpdate.call(vm, to));</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> VueUrlPersist;</span><br></pre></td></tr></table></figure>
<p>使用起来和其他的插件没什么差别</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">import</span> VueUrlPersist <span class="keyword">from</span> <span class="string">&quot;./views/js/VueUrlPersist&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vueUrlPersist = <span class="keyword">new</span> VueUrlPersist();</span><br><span class="line">Vue.use(vueUrlPersist);</span><br></pre></td></tr></table></figure>
<p>在需要使用的组件中只要声明这个属性就好了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">&quot;Form2Tab&quot;</span>,</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      form: &#123;</span><br><span class="line">        keyword: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        sex: <span class="number">0</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      exps: [<span class="string">&quot;form&quot;</span>],</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然而，使用 vue 插件有个致命的缺陷：无论是否需要，都会为每个组件中都混入三个生命周期函数，吾辈没有找到一种可以根据实例中是否包含某个值而决定是否混入的方式。</p>
<h4 id="使用高阶函数"><a href="#使用高阶函数" class="headerlink" title="使用高阶函数"></a>使用高阶函数</h4><p>所以，我们使用 <code>高阶函数</code> + <code>mixin</code> 的形式看看。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; debounce, get, set &#125; <span class="keyword">from</span> <span class="string">&quot;./common&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VueUrlPersist</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 一些选项</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">&#123; key = <span class="string">&quot;qb&quot;</span> &#125; = &#123;&#125;</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.key = key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 为 vue 实例上的字段进行深度赋值</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">setInitData</span>(<span class="params">vm, exp, urlData</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> oldVal = get(vm, exp, <span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">const</span> newVal = urlData[exp];</span><br><span class="line">    <span class="comment">//如果原值是对象且新值也是对象，则进行浅合并</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      oldVal === <span class="literal">undefined</span> ||</span><br><span class="line">      oldVal === <span class="literal">null</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> oldVal === <span class="string">&quot;string&quot;</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> oldVal === <span class="string">&quot;number&quot;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      set(vm, exp, newVal);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> oldVal === <span class="string">&quot;object&quot;</span> &amp;&amp; <span class="keyword">typeof</span> newVal === <span class="string">&quot;object&quot;</span>) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.assign(get(vm, exp), newVal);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化一些数据需要序列化/反序列化到 url data 上</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>vm vue 实例</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">initUrlDataByCreated</span>(<span class="params">vm, exps</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> key = <span class="built_in">this</span>.key;</span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(vm.$route.query[key] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">    exps.forEach(<span class="function">(<span class="params">exp</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.setInitData(vm, exp, urlData);</span><br><span class="line">      vm.$watch(</span><br><span class="line">        exp,</span><br><span class="line">        debounce(<span class="function"><span class="keyword">function</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">          urlData[exp] = val;</span><br><span class="line">          <span class="keyword">if</span> (vm.$route.query[key] === <span class="built_in">JSON</span>.stringify(urlData)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          vm.$router.replace(&#123;</span><br><span class="line">            query: &#123;</span><br><span class="line">              ...vm.$route.query,</span><br><span class="line">              [key]: <span class="built_in">JSON</span>.stringify(urlData),</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;, <span class="number">1000</span>),</span><br><span class="line">        &#123;</span><br><span class="line">          deep: <span class="literal">true</span>,</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 在组件被 vue-router 路由复用时，单独进行初始化数据</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>vm vue 实例</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>route 将要改变的路由对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">initUrlDataByRouteUpdate</span>(<span class="params">vm, exps, route</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> urlData = <span class="built_in">JSON</span>.parse(route.query[<span class="built_in">this</span>.key] || <span class="string">&quot;&#123;&#125;&quot;</span>);</span><br><span class="line">    exps.forEach(<span class="function">(<span class="params">exp</span>) =&gt;</span> <span class="built_in">this</span>.setInitData(vm, exp, urlData));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 生成可以 mixin 到 vue 实例的对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>exps 监视的数据的表达式数组</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns <span class="type">&#123;&#123;created(): void, beforeRouteEnter(*=, *, *): void, beforeRouteUpdate(*=, *, *): void&#125;</span></span>&#125;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">generateInitUrlData</span>(<span class="params">...exps</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> _this = <span class="built_in">this</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="function"><span class="title">created</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        _this.initUrlDataByCreated(<span class="built_in">this</span>, exps);</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">beforeRouteUpdate</span>(<span class="params">to, <span class="keyword">from</span>, next</span>)</span> &#123;</span><br><span class="line">        _this.initUrlDataByRouteUpdate(<span class="built_in">this</span>, exps, to);</span><br><span class="line">        next();</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function"><span class="title">beforeRouteEnter</span>(<span class="params">to, <span class="keyword">from</span>, next</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;beforeRouteEnter&quot;</span>);</span><br><span class="line">        next(<span class="function">(<span class="params">vm</span>) =&gt;</span> _this.initUrlDataByRouteUpdate(vm, exps, to));</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 修改一些配置</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>options 配置项</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="title">config</span>(<span class="params">options</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.assign(<span class="built_in">this</span>, options);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> vueUrlPersist = <span class="keyword">new</span> VueUrlPersist();</span><br><span class="line"><span class="keyword">const</span> generateInitUrlData = vueUrlPersist.generateInitUrlData.bind(</span><br><span class="line">  vueUrlPersist</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; vueUrlPersist, generateInitUrlData, VueUrlPersist &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> vueUrlPersist;</span><br></pre></td></tr></table></figure>
<p>使用起来几乎一样简单</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; generateInitUrlData &#125; <span class="keyword">from</span> <span class="string">&quot;./js/VueUrlPersist&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">&quot;Form1&quot;</span>,</span><br><span class="line">  mixins: [generateInitUrlData(<span class="string">&quot;form&quot;</span>)],</span><br><span class="line">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      form: &#123;</span><br><span class="line">        keyword: <span class="string">&quot;&quot;</span>,</span><br><span class="line">        hobbyList: [],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>看起来，使用高阶函数也没有比 Vue 插件麻烦太多。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总的来说，虽然路途坎坷，不过这个问题还是很有趣的，而且确实能解决实际的问题，所以还是有研究价值的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/02/02/1342b132059a48f4a822bcd182d8bfe1/" data-id="ckmcqox5j00bm0kuv7m0e8he9" data-title="浅谈 Vue SPA 网站 URL 保存数据实践" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">工程化</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/02/02/05a42034e34e4636aace32cec81187f5/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          JavaScript 异步数组
        
      </div>
    </a>
  
  
    <a href="/2020/02/02/1f0ca923689549cca19517e74071e0ed/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">面相 vue 开发者的 react 入坑指南</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/" rel="tag">css</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/electron/" rel="tag">electron</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grid/" rel="tag">grid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jetbrains/" rel="tag">jetbrains</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/" rel="tag">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/typescript/" rel="tag">typescript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webstorm/" rel="tag">webstorm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AA%E4%BA%BA/" rel="tag">个人</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%AC%E5%8F%B8/" rel="tag">公司</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%91%A8%E6%8A%A5/" rel="tag">周报</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%A3%E5%91%8A/" rel="tag">宣告</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" rel="tag">工程化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90/" rel="tag">开源</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%82%E6%AD%A5/" rel="tag">异步</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BE%85%E6%9B%B4%E6%96%B0/" rel="tag">待更新</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BB%8F%E9%AA%8C/" rel="tag">经验</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E4%B9%A6/" rel="tag">读书</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BD%AC%E8%BD%BD/" rel="tag">转载</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/css/" style="font-size: 12.14px;">css</a> <a href="/tags/electron/" style="font-size: 15.71px;">electron</a> <a href="/tags/git/" style="font-size: 12.86px;">git</a> <a href="/tags/grid/" style="font-size: 10.71px;">grid</a> <a href="/tags/java/" style="font-size: 19.29px;">java</a> <a href="/tags/javascript/" style="font-size: 20px;">javascript</a> <a href="/tags/jetbrains/" style="font-size: 12.14px;">jetbrains</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/markdown/" style="font-size: 10.71px;">markdown</a> <a href="/tags/react/" style="font-size: 14.29px;">react</a> <a href="/tags/sql/" style="font-size: 14.29px;">sql</a> <a href="/tags/typescript/" style="font-size: 12.14px;">typescript</a> <a href="/tags/vscode/" style="font-size: 12.86px;">vscode</a> <a href="/tags/vue/" style="font-size: 16.43px;">vue</a> <a href="/tags/webstorm/" style="font-size: 10px;">webstorm</a> <a href="/tags/windows/" style="font-size: 17.14px;">windows</a> <a href="/tags/%E4%B8%AA%E4%BA%BA/" style="font-size: 12.86px;">个人</a> <a href="/tags/%E5%85%AC%E5%8F%B8/" style="font-size: 10px;">公司</a> <a href="/tags/%E5%91%A8%E6%8A%A5/" style="font-size: 10px;">周报</a> <a href="/tags/%E5%AE%A3%E5%91%8A/" style="font-size: 10px;">宣告</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 13.57px;">工具</a> <a href="/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="font-size: 17.86px;">工程化</a> <a href="/tags/%E5%BC%80%E6%BA%90/" style="font-size: 10px;">开源</a> <a href="/tags/%E5%BC%82%E6%AD%A5/" style="font-size: 15px;">异步</a> <a href="/tags/%E5%BE%85%E6%9B%B4%E6%96%B0/" style="font-size: 10.71px;">待更新</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 18.57px;">杂谈</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%BB%8F%E9%AA%8C/" style="font-size: 11.43px;">经验</a> <a href="/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 12.14px;">读书</a> <a href="/tags/%E8%BD%AC%E8%BD%BD/" style="font-size: 11.43px;">转载</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/14/8fb2d58463ae4191ac064a76e15bffbd/">2021 第十周</a>
          </li>
        
          <li>
            <a href="/2021/03/12/7e7131c07c984d928ba3fefa7a9cef06/">读书-[颓废与沉默：透视犬儒文化]</a>
          </li>
        
          <li>
            <a href="/2021/03/02/db74e6e5d2444bc3b6e185a7b338bbf6/">electron 开发经验之谈系列-在渲染、主进程间共享数据</a>
          </li>
        
          <li>
            <a href="/2021/02/27/06cb464179cf45c598208534705aae3c/">2020 吾辈在公司推动的前端技术演进</a>
          </li>
        
          <li>
            <a href="/2021/02/23/cd66150d2b86448590fcc9bb2419c0b2/">实践 lerna monorepo</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>